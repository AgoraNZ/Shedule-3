<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Agora Schedule 3 – Farm Records</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #eef;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background-color: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      margin-bottom: 30px;
    }
    h1, h2 {
      text-align: center;
      color: #002B5C;
    }
    .search-input {
      width: 100%;
      padding: 10px;
      margin: 15px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      font-size: 14px;
      text-align: left;
    }
    th {
      background-color: #f0f0f0;
    }
    tr.record:hover {
      background-color: #dcdcdc;
      cursor: pointer;
    }
    .btn {
      background-color: #002B5C;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 20px;
      display: block;
      width: 200px;
      margin-left: auto;
      margin-right: auto;
    }
    .btn:hover {
      background-color: #001f3f;
    }
    .error {
      color: red;
      text-align: center;
    }
    .form-field {
      margin-bottom: 10px;
    }
    .form-field label {
      font-weight: bold;
      display: block;
      margin-bottom: 5px;
    }
    .form-field input {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <!-- Grid Section -->
  <div class="container" id="grid-container">
    <h1>All Farms – Agora Schedule 3</h1>
    <input type="text" id="searchInput" class="search-input" placeholder="Search by Dairy Number, Farm Name, etc..." oninput="filterGrid()">
    <table id="recordsTable">
      <thead>
        <tr>
          <th>Dairy Number</th>
          <th>Farm Name</th>
          <th>Dairy Company</th>
          <th>Region</th>
        </tr>
      </thead>
      <tbody id="recordsTbody">
        <!-- Rows are populated here -->
      </tbody>
    </table>
    <p id="gridError" class="error"></p>
  </div>

  <!-- Form Section for Auto-Population -->
  <div class="container" id="form-container" style="display: none;">
    <h2>Farm Details</h2>
    <div class="form-field">
      <label for="form-dairy-number">Dairy Number</label>
      <input type="text" id="form-dairy-number" readonly>
    </div>
    <div class="form-field">
      <label for="form-dairy-company">Dairy Company</label>
      <input type="text" id="form-dairy-company">
    </div>
    <div class="form-field">
      <label for="form-address">Address</label>
      <input type="text" id="form-address">
    </div>
    <div class="form-field">
      <label for="form-customer-name">Customer Name</label>
      <input type="text" id="form-customer-name">
    </div>
    <div class="form-field">
      <label for="form-region">Region</label>
      <input type="text" id="form-region">
    </div>
    <div class="form-field">
      <label for="form-farm-name">Farm Name</label>
      <input type="text" id="form-farm-name">
    </div>
    <div class="form-field">
      <label for="form-island">Island</label>
      <input type="text" id="form-island">
    </div>
    <button class="btn" onclick="hideForm()">Close Form</button>
  </div>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
  <script>
    // Use the same Firebase configuration as your original form.
    const firebaseConfig = {
      apiKey: "AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
      authDomain: "dairy-farm-record-system.firebaseapp.com",
      projectId: "dairy-farm-record-system",
      storageBucket: "dairy-farm-record-system.appspot.com",
      messagingSenderId: "422124188212",
      appId: "1:422124188212:web:1bd31bee8d6e91e301d061"
    };
    firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();

    // Hard-coded list of dairy numbers that have files in the folder.
    // Replace this array with your dynamic list if available.
    const dairyNumbers = ["49"]; // Add more as needed.

    // Load all farms on page load.
    async function loadAllRecords() {
      const tbody = document.getElementById("recordsTbody");
      const gridError = document.getElementById("gridError");
      tbody.innerHTML = "";
      gridError.textContent = "";
      
      for (const dairy of dairyNumbers) {
        const filePath = `Agora schedule 3 farm details/${dairy}.json`;
        const fileRef = storage.ref(filePath);
        try {
          const url = await fileRef.getDownloadURL();
          console.log("Loaded URL for dairy", dairy, ":", url);
          const res = await fetch(url);
          if (!res.ok) throw new Error("HTTP error " + res.status);
          const data = await res.json();
          addRecordRow(dairy, data);
        } catch (error) {
          console.error("Error loading dairy", dairy, error);
          addRecordRow(dairy, { farmName: "Error", dairyCompany: "Error", region: "Error" }, error.message);
        }
      }
      if (!tbody.hasChildNodes()) {
        gridError.textContent = "No farm records loaded.";
      }
    }

    // Add a row to the grid table for a given dairy record.
    function addRecordRow(dairy, data, errorMsg) {
      const tbody = document.getElementById("recordsTbody");
      const tr = document.createElement("tr");
      tr.classList.add("record");
      if (errorMsg) {
        tr.innerHTML = `<td colspan="4" class="error">Error loading dairy ${dairy}: ${errorMsg}</td>`;
      } else {
        tr.innerHTML = `
          <td>${dairy}</td>
          <td>${data.farmName || "N/A"}</td>
          <td>${data.dairyCompany || "N/A"}</td>
          <td>${data.region || "N/A"}</td>
        `;
        // When the row is clicked, auto-populate the form with full details.
        tr.onclick = function() {
          populateForm(dairy, data);
        };
      }
      tbody.appendChild(tr);
    }

    // Auto-populate the form with data from the selected record.
    function populateForm(dairy, data) {
      document.getElementById("form-dairy-number").value = dairy;
      document.getElementById("form-dairy-company").value = data.dairyCompany || "";
      document.getElementById("form-address").value = data.address || "";
      document.getElementById("form-customer-name").value = data.customerName || "";
      document.getElementById("form-region").value = data.region || "";
      document.getElementById("form-farm-name").value = data.farmName || "";
      document.getElementById("form-island").value = data.island || "";
      // Show the form.
      document.getElementById("form-container").style.display = "block";
      // Scroll to form.
      document.getElementById("form-container").scrollIntoView({ behavior: "smooth" });
    }

    // Hide the form.
    function hideForm() {
      document.getElementById("form-container").style.display = "none";
    }

    // Filter the grid table based on the search input.
    function filterGrid() {
      const filter = document.getElementById("searchInput").value.toLowerCase();
      const rows = document.querySelectorAll("#recordsTbody tr");
      rows.forEach(row => {
        let visible = false;
        row.querySelectorAll("td").forEach(td => {
          if (td.textContent.toLowerCase().indexOf(filter) > -1) {
            visible = true;
          }
        });
        row.style.display = visible ? "" : "none";
      });
    }

    // Auto-load all records when the page loads.
    window.addEventListener("load", loadAllRecords);
  </script>
</body>
</html>