<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agora Schedule 3 – Auto Populate Records</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #eef;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      margin-bottom: 30px;
    }
    h1, h2 {
      text-align: center;
      color: #002B5C;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 8px;
      text-align: left;
      font-size: 14px;
    }
    th {
      background-color: #f0f0f0;
    }
    tr.record:hover {
      background-color: #dcdcdc;
      cursor: pointer;
    }
    .form-field {
      margin-bottom: 10px;
    }
    label {
      font-weight: bold;
      display: block;
    }
    input[type="text"],
    input[type="date"] {
      width: 100%;
      padding: 8px;
      box-sizing: border-box;
      margin-top: 5px;
    }
    .btn {
      background-color: #002B5C;
      color: #fff;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      border-radius: 5px;
      margin-top: 10px;
    }
    .btn:hover {
      background-color: #001f3f;
    }
    .search-input {
      width: 100%;
      padding: 8px;
      margin-top: 10px;
      margin-bottom: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .error {
      color: red;
      text-align: center;
    }
  </style>
</head>
<body>
  <!-- Grid Section -->
  <div class="container" id="grid-container">
    <h1>All Farms – Agora Schedule 3</h1>
    <p>Below are the records pulled from the folder. Click a row to auto‐populate the form below.</p>
    <input type="text" id="searchInput" class="search-input" placeholder="Search by any field..." oninput="filterGrid()">
    <table id="recordsTable">
      <thead>
        <tr>
          <th>Dairy Number</th>
          <th>Farm Name</th>
          <th>Dairy Company</th>
        </tr>
      </thead>
      <tbody id="recordsTbody">
        <!-- Rows will be added here -->
      </tbody>
    </table>
    <p id="gridError" class="error"></p>
  </div>

  <!-- Form Section -->
  <div class="container" id="form-container" style="display: none;">
    <h2>Farm Details</h2>
    <div class="form-field">
      <label for="form-dairy-number">Dairy Number:</label>
      <input type="text" id="form-dairy-number" readonly>
    </div>
    <div class="form-field">
      <label for="form-dairy-company">Dairy Company:</label>
      <input type="text" id="form-dairy-company">
    </div>
    <div class="form-field">
      <label for="form-address">Address:</label>
      <input type="text" id="form-address">
    </div>
    <div class="form-field">
      <label for="form-customer-name">Customer Name:</label>
      <input type="text" id="form-customer-name">
    </div>
    <div class="form-field">
      <label for="form-region">Region:</label>
      <input type="text" id="form-region">
    </div>
    <div class="form-field">
      <label for="form-farm-name">Farm Name:</label>
      <input type="text" id="form-farm-name">
    </div>
    <div class="form-field">
      <label for="form-island">Island:</label>
      <input type="text" id="form-island">
    </div>
    <!-- For brevity, checklistExtra details can be added similarly if needed -->
    <button class="btn" onclick="hideForm()">Close Form</button>
  </div>

  <!-- Firebase Scripts -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
  <script>
    // Initialize Firebase with your exact configuration.
    const firebaseConfig = {
      apiKey: "AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
      authDomain: "dairy-farm-record-system.firebaseapp.com",
      projectId: "dairy-farm-record-system",
      storageBucket: "dairy-farm-record-system.appspot.com",
      messagingSenderId: "422124188212",
      appId: "1:422124188212:web:1bd31bee8d6e91e301d061"
    };
    firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();

    // Hard-coded list of dairy numbers known to exist.
    const dairyNumbers = ["49"]; // Add more dairy numbers as needed.

    // Load all farms from the folder using direct file references.
    async function loadAllRecords() {
      const tbody = document.getElementById("recordsTbody");
      const gridError = document.getElementById("gridError");
      tbody.innerHTML = "";
      gridError.textContent = "";
      for (const dairy of dairyNumbers) {
        const filePath = `Agora schedule 3 farm details/${dairy}.json`;
        const fileRef = storage.ref(filePath);
        try {
          const url = await fileRef.getDownloadURL();
          console.log("Loaded URL for dairy", dairy, ":", url);
          const res = await fetch(url);
          if (!res.ok) throw new Error("HTTP error " + res.status);
          const data = await res.json();
          addRecordRow(dairy, data);
        } catch (error) {
          console.error("Error loading dairy", dairy, error);
          // Optionally add a row indicating the error.
          addRecordRow(dairy, { farmName: "Error", dairyCompany: "Error" });
        }
      }
      // If no rows were added, display an error message.
      if (!tbody.hasChildNodes()) {
        gridError.textContent = "No farm records loaded.";
      }
    }

    // Add a row to the table for a given dairy record.
    function addRecordRow(dairy, data) {
      const tbody = document.getElementById("recordsTbody");
      const tr = document.createElement("tr");
      tr.classList.add("record");
      tr.innerHTML = `
        <td>${dairy}</td>
        <td>${data.farmName || "N/A"}</td>
        <td>${data.dairyCompany || "N/A"}</td>
      `;
      // When the row is clicked, populate the form.
      tr.onclick = function() {
        populateForm(dairy, data);
      };
      tbody.appendChild(tr);
    }

    // Populate the form with data from the selected record.
    function populateForm(dairy, data) {
      document.getElementById("form-dairy-number").value = dairy;
      document.getElementById("form-dairy-company").value = data.dairyCompany || "";
      document.getElementById("form-address").value = data.address || "";
      document.getElementById("form-customer-name").value = data.customerName || "";
      document.getElementById("form-region").value = data.region || "";
      document.getElementById("form-farm-name").value = data.farmName || "";
      document.getElementById("form-island").value = data.island || "";
      // Show the form container.
      document.getElementById("form-container").style.display = "block";
      // Scroll to the form.
      document.getElementById("form-container").scrollIntoView({ behavior: "smooth" });
    }

    // Hide the form.
    function hideForm() {
      document.getElementById("form-container").style.display = "none";
    }

    // Simple filtering function for the grid.
    function filterGrid() {
      const filter = document.getElementById("searchInput").value.toLowerCase();
      const rows = document.querySelectorAll("#recordsTbody tr");
      rows.forEach(row => {
        let visible = false;
        row.querySelectorAll("td").forEach(td => {
          if (td.textContent.toLowerCase().indexOf(filter) > -1) {
            visible = true;
          }
        });
        row.style.display = visible ? "" : "none";
      });
    }

    // Auto-load records when the page loads.
    window.addEventListener("load", loadAllRecords);
  </script>
</body>
</html>