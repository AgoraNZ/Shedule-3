<!DOCTYPE html>
<html lang="en">
<head>
  <!-- META & STYLES -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agora Schedule 3 Form</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
  <style>
    /* Overall background and common styling */
    body {
      background-color: #d2d7dd;
      color: #000;
      font-family: Arial, sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      margin: 0;
    }
    .container, .record-container, .all-farms-container {
      background-color: #d2d7dd;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      max-width: 800px;
      width: 100%;
    }
    .record-container, .all-farms-container {
      background-color: #fff;
    }
    h1, h2, h3, h4 { text-align: center; }
    h1, h2 { color: #333; }
    h3 { color: #002B5C; margin-top: 20px; }
    h4 { color: #555; margin-top: 10px; }
    label { color: #000; margin-top: 10px; }
    /* Enable autocorrect on text inputs */
    input[type="text"], textarea {
      autocorrect: on;
    }
    button {
      background-color: #FFD700;
      color: #000;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      display: inline-block;
      margin: 10px 5px;
      border-radius: 5px;
    }
    button:hover { background-color: #E6C200; }
    .back-button { background-color: #002B5C; color: #fff; }
    .image-upload { display: none; }
    .image-preview {
      display: none;
      max-width: 200px;
      max-height: 200px;
      margin-top: 5px;
      border: 2px solid #ccc;
    }
    .detail-box {
      margin-top: 15px;
      padding: 10px;
      border: 1px dashed #888;
    }
    .checklist-extra {
      margin-top: 5px;
    }
    .version { text-align: center; margin-top: 20px; color: #333; font-size: 12px; }
    /* All Farms grid styling */
    .all-farms-container table {
      width: 100%;
      border-collapse: collapse;
    }
    .all-farms-container th, .all-farms-container td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    .all-farms-container th {
      background-color: #002B5C;
      color: #fff;
    }
  </style>
</head>
<body>
  <!-- MAIN FORM CONTAINER -->
  <div class="container" id="form-container">
    <img src="https://firebasestorage.googleapis.com/v0/b/dairy-farm-record-system.appspot.com/o/Agora%20Logo%2F2F6-1YdaEP.jpeg?alt=media" alt="Logo" class="logo" style="display:block; margin: 0 auto 20px; width:250px;">
    <h1>Agora Schedule 3 Form</h1>
    <form id="schedule3-form">
      <!-- Farm Details Section (with autocorrect enabled) -->
      <div class="section mb-4">
        <h2>Farm Details</h2>
        <label for="dairy-number">Dairy Number:</label>
        <input type="text" class="form-control" id="dairy-number" name="dairy-number" onblur="handleDairyNumberBlur();" autocapitalize="words" autocorrect="on" spellcheck="true">
        <label for="dairy-company">Dairy Company:</label>
        <input type="text" class="form-control" id="dairy-company" name="dairy-company" list="dairy-company-list" placeholder="Type or select..." autocapitalize="words" autocorrect="on" spellcheck="true">
        <datalist id="dairy-company-list"></datalist>
        <label for="address">Address:</label>
        <input type="text" class="form-control" id="address" name="address" autocapitalize="words" autocorrect="on" spellcheck="true">
        <label for="customer-name">Customer Name:</label>
        <input type="text" class="form-control" id="customer-name" name="customer-name" autocapitalize="words" autocorrect="on" spellcheck="true">
        <label for="region">Region:</label>
        <select id="region" name="region" class="form-select">
          <option value="northland">Northland</option>
          <option value="auckland">Auckland</option>
          <option value="waikato">Waikato</option>
          <option value="bay-of-plenty">Bay of Plenty</option>
          <option value="gisborne">Gisborne</option>
          <option value="hawkes-bay">Hawke's Bay</option>
          <option value="taranaki">Taranaki</option>
          <option value="manawatu-wanganui">Manawatu-Wanganui</option>
          <option value="wellington">Wellington</option>
          <option value="nelson">Nelson</option>
          <option value="marlborough">Marlborough</option>
          <option value="west-coast">West Coast</option>
          <option value="canterbury">Canterbury</option>
          <option value="otago">Otago</option>
          <option value="southland">Southland</option>
        </select>
        <label for="farm-name">Farm Name:</label>
        <input type="text" class="form-control" id="farm-name" name="farm-name" autocapitalize="words" autocorrect="on" spellcheck="true">
        <label for="island">Island:</label>
        <select id="island" name="island" class="form-select">
          <option value="north-island">North Island</option>
          <option value="south-island">South Island</option>
        </select>
        <label for="visit-date">Visit Date:</label>
        <input type="date" class="form-control" id="visit-date" name="visit-date">
        <label for="visit-type">Visit Type:</label>
        <input type="text" class="form-control" id="visit-type" name="visit-type" value="Schedule 3 Check" readonly autocapitalize="words" autocorrect="on" spellcheck="true">
      </div>
      
      <!-- Schedule 3 Checklist Section -->
      <div class="section mb-4">
        <h2>Checklist Items</h2>
        <div id="checklist-items"></div>
      </div>
      
      <!-- Additional Schedule 3 Details -->
      <div class="section mb-4">
        <h2>Additional Details</h2>
        <div class="detail-box">
          <label for="install-date">Install Date:</label>
          <input type="date" class="form-control" id="install-date" name="install-date" autocorrect="on" spellcheck="true">
        </div>
        <div class="detail-box">
          <label for="replacement-due">Replacement Due Date:</label>
          <input type="date" class="form-control" id="replacement-due" name="replacement-due" autocorrect="on" spellcheck="true">
        </div>
      </div>
      
      <!-- Buttons at the bottom of the form -->
      <div style="text-align: center;">
        <button type="button" onclick="generatePDFSchedule3()">Generate PDF</button>
        <button type="button" onclick="viewRecordsSchedule3()">View All Records</button>
        <button type="button" onclick="showAllFarms()">All Farms</button>
      </div>
    </form>
    <div class="version">Version 1.0 (Agora Schedule 3)</div>
  </div>
  
  <!-- RECORDS VIEW (Schedule 3) -->
  <div id="record-container" class="record-container" style="display: none;">
    <h2>All Schedule 3 Records</h2>
    <div class="search-container">
      <input type="text" id="search-dairy-number" class="form-control" placeholder="Search by Dairy Number" oninput="filterRecordsSchedule3()">
    </div>
    <div id="record-list" class="record-list"></div>
    <button class="back-button" onclick="goBackSchedule3()">Back to Form</button>
  </div>
  
  <!-- ALL FARMS VIEW (Schedule 3) -->
  <div id="all-farms-container" class="all-farms-container" style="display: none;">
    <h2>All Farms - Schedule 3</h2>
    <div id="farms-grid"></div>
    <button class="back-button" onclick="backToFormSchedule3()">Back to Form</button>
  </div>
  
  <!-- SCRIPTS -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.0.3/dexie.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script>
    /* FIREBASE & DEXIE INIT */
    const { jsPDF } = window.jspdf;
    const firebaseConfig = {
      apiKey: "AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
      authDomain: "dairy-farm-record-system.firebaseapp.com",
      projectId: "dairy-farm-record-system",
      storageBucket: "dairy-farm-record-system.appspot.com",
      messagingSenderId: "422124188212",
      appId: "1:422124188212:web:1bd31bee8d6e91e301d061"
    };
    firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();
    const firestore = firebase.firestore();
    const db = new Dexie("OfflineData");
    db.version(5).stores({
      schedule3Forms: "dairyNumber",
      dairyCompanies: "++id, name",
      pdfQueue: "++id,dairyNumber,fileName,uploaded,target"
    });
    
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(reg => console.log('Service Worker registered:', reg.scope))
        .catch(err => console.error('SW registration failed:', err));
    }
    
    /* Utility Functions */
    function toTitleCase(str) {
      return str.replace(/\w\S*/g, function(txt) {
        return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
      });
    }
    function autoCapitalizeInput(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('blur', () => { el.value = toTitleCase(el.value); });
    }
    
    async function setupDairyCompanyDatalist() {
      const defaultCompanies = [
        "Fonterra", "Dairy Goat Co-op", "Green Valley Dairies", "Maui Milk",
        "Oceania", "OFI", "Synlait Milk LTD", "Tatua", "Danone", "Fresha Valley LTD",
        "Mataura Valley Milk", "Open Country Dairy LTD", "Waiu", "Westland Milk Products"
      ];
      const userCompanies = await db.dairyCompanies.toArray();
      const allCompanies = [...defaultCompanies];
      userCompanies.forEach(u => { if (!allCompanies.includes(u.name)) { allCompanies.push(u.name); } });
      const datalist = document.getElementById('dairy-company-list');
      datalist.innerHTML = "";
      allCompanies.forEach(c => { 
        const opt = document.createElement('option');
        opt.value = c;
        datalist.appendChild(opt);
      });
      const dairyCompanyInput = document.getElementById('dairy-company');
      dairyCompanyInput.addEventListener('blur', async () => {
        dairyCompanyInput.value = toTitleCase(dairyCompanyInput.value.trim());
        const typedValue = dairyCompanyInput.value;
        if (typedValue && !allCompanies.includes(typedValue)) {
          await db.dairyCompanies.add({ name: typedValue });
          allCompanies.push(typedValue);
          const newOpt = document.createElement('option');
          newOpt.value = typedValue;
          datalist.appendChild(newOpt);
        }
      });
    }
    
    async function fetchFarmDetailsSchedule3() {
      const dairyNumber = document.getElementById('dairy-number').value.trim();
      if (!dairyNumber) return;
      const storageRef = storage.ref(`Agora schedule 3 farm details/${dairyNumber}.json`);
      try {
        const url = await storageRef.getDownloadURL();
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to fetch farm details');
        const data = await response.json();
        if (data) {
          document.getElementById('dairy-company').value = toTitleCase(data.dairyCompany || '');
          document.getElementById('address').value = toTitleCase(data.address || '');
          document.getElementById('customer-name').value = toTitleCase(data.customerName || '');
          document.getElementById('region').value = data.region || '';
          document.getElementById('farm-name').value = toTitleCase(data.farmName || '');
          document.getElementById('island').value = data.island || '';
          // Additional Schedule3 fields:
          document.getElementById('install-date').value = data.installDate || "";
          document.getElementById('replacement-due').value = data.replacementDue || "";
        }
      } catch (error) {
        console.log('No Schedule3 farm details found or error:', error);
      }
    }
    
    async function checkOrCreateSchedule3Record() {
      const dairyNumber = document.getElementById('dairy-number').value.trim();
      if (!dairyNumber) return;
      let record = await db.schedule3Forms.get(dairyNumber);
      if (!record) {
        record = { dairyNumber, formData: {}, creationTime: Date.now() };
        await db.schedule3Forms.put(record);
      }
    }
    async function handleDairyNumberBlur() {
      const dairyNumber = document.getElementById('dairy-number').value.trim();
      if (!dairyNumber) return;
      fetchFarmDetailsSchedule3();
      await checkOrCreateSchedule3Record();
    }
    
    /* Create Schedule3 Checklist Items with extra fields */
    function createChecklistItemsSchedule3() {
      const items = [
        "Cluster to milk line", 
        "Cluster short Pulse tubes", 
        "Cluster pulse tube to pulsator", 
        "Cluster bowl seal", 
        "Cluster small ring seal", 
        "Liners", 
        "Milk filter seal", 
        "Front Vat tap seal", 
        "Back vat tap seal", 
        "Vat door seal"
      ];
      const container = document.getElementById("checklist-items");
      container.innerHTML = "";
      items.forEach(item => {
        // Sanitize the item string for use in field names
        const sanitized = item.replace(/\s+/g, "_").toLowerCase();
        const itemContainer = document.createElement("div");
        itemContainer.classList.add("checklist-item");
        // Main label and standard fields
        const label = document.createElement("label");
        label.textContent = item;
        itemContainer.appendChild(label);
        const statusSelect = document.createElement("select");
        statusSelect.classList.add("form-select");
        statusSelect.name = `status-${sanitized}`;
        statusSelect.innerHTML = `
          <option value="ok">OK</option>
          <option value="attention-required">Attention Required</option>
          <option value="na">N/A</option>
          <option value="not-checked">Not Checked</option>
        `;
        itemContainer.appendChild(statusSelect);
        const commentsInput = document.createElement("input");
        commentsInput.type = "text";
        commentsInput.classList.add("form-control");
        commentsInput.name = `comments-${sanitized}`;
        commentsInput.placeholder = "Comments";
        commentsInput.setAttribute("spellcheck", "true");
        commentsInput.setAttribute("autocorrect", "on");
        itemContainer.appendChild(commentsInput);
        // File inputs for photos
        for (let i = 0; i < 2; i++) {
          const fileInput = document.createElement("input");
          fileInput.type = "file";
          fileInput.classList.add("form-control", "image-upload");
          itemContainer.appendChild(fileInput);
          const preview = document.createElement("img");
          preview.classList.add("image-preview");
          itemContainer.appendChild(preview);
        }
        // Extra input for Rubberware Details (if needed)
        const rubberwareInput = document.createElement("input");
        rubberwareInput.type = "text";
        rubberwareInput.classList.add("form-control");
        rubberwareInput.name = `rubberware-${sanitized}`;
        rubberwareInput.placeholder = "General Rubberware Details";
        rubberwareInput.setAttribute("spellcheck", "true");
        rubberwareInput.setAttribute("autocorrect", "on");
        itemContainer.appendChild(rubberwareInput);
        // New extra fields: Quantity, Size, Item Install Date, Expiry Date
        const extraDiv = document.createElement("div");
        extraDiv.classList.add("checklist-extra");
        extraDiv.innerHTML = `
          <input type="text" class="form-control mb-1" name="quantity-${sanitized}" placeholder="Quantity" autocorrect="on" spellcheck="true">
          <input type="text" class="form-control mb-1" name="size-${sanitized}" placeholder="Size" autocorrect="on" spellcheck="true">
          <input type="date" class="form-control mb-1" name="item-install-${sanitized}" placeholder="Item Install Date">
          <input type="date" class="form-control" name="expiry-date-${sanitized}" placeholder="Expiry Date">
        `;
        itemContainer.appendChild(extraDiv);
        statusSelect.addEventListener("change", () => {
          const fileInputs = itemContainer.querySelectorAll('input[type="file"]');
          fileInputs.forEach(inp => {
            inp.style.display = (statusSelect.value === "attention-required") ? "block" : "none";
          });
        });
        container.appendChild(itemContainer);
      });
    }
    
    /* LOAD, CLEAR & SAVE Data for Schedule 3 */
    function clearEntireFormSchedule3() {
      document.getElementById("schedule3-form").reset();
      const imageUploads = document.querySelectorAll(".image-upload");
      imageUploads.forEach(inp => { inp.style.display = "none"; });
      const previews = document.querySelectorAll(".image-preview");
      previews.forEach(img => { img.src = ""; img.style.display = "none"; });
    }
    
    async function saveSchedule3FormData() {
      const dairyNumber = document.getElementById("dairy-number").value.trim();
      if (!dairyNumber) return;
      let record = await db.schedule3Forms.get(dairyNumber);
      if (!record) { record = { dairyNumber, formData: {}, creationTime: Date.now() }; }
      const form = document.getElementById("schedule3-form");
      const formDataObj = new FormData(form);
      const data = Object.fromEntries(Array.from(formDataObj.entries()).filter(([k, v]) => v.trim() !== ""));
      
      // Save checklist items data (including extra fields)
      const checklistContainers = document.getElementById("checklist-items").children;
      const checklistItemsData = {};
      for (let container of checklistContainers) {
        const label = container.querySelector("label");
        if (!label) continue;
        const key = label.textContent.trim();
        const sanitized = key.replace(/\s+/g, "_").toLowerCase();
        const status = container.querySelector(`select[name="status-${sanitized}"]`)?.value || "";
        let comments = container.querySelector(`input[name="comments-${sanitized}"]`)?.value || "";
        const rubberware = container.querySelector(`input[name="rubberware-${sanitized}"]`)?.value || "";
        const quantity = container.querySelector(`input[name="quantity-${sanitized}"]`)?.value || "";
        const size = container.querySelector(`input[name="size-${sanitized}"]`)?.value || "";
        const itemInstall = container.querySelector(`input[name="item-install-${sanitized}"]`)?.value || "";
        const expiryDate = container.querySelector(`input[name="expiry-date-${sanitized}"]`)?.value || "";
        let imagesBase64 = [];
        const fileInputs = container.querySelectorAll('input[type="file"]');
        for (let fi of fileInputs) {
          if (fi.files && fi.files[0]) {
            const base64 = await convertFileToBase64(fi.files[0]);
            imagesBase64.push(base64);
          }
        }
        if (status === "attention-required" && imagesBase64.length > 0) {
          const photoNote = imagesBase64.length > 1 ? " (see attached photos)" : " (see attached photo)";
          comments += photoNote;
        }
        checklistItemsData[key] = { 
          status, 
          comments, 
          rubberware, 
          quantity, 
          size, 
          itemInstall, 
          expiryDate, 
          imagesBase64 
        };
      }
      data.checklistItems = checklistItemsData;
      record.formData = data;
      await db.schedule3Forms.put(record);
    }
    
    function convertFileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    
    // Update the farm details JSON to include checklistItems data (only the extra fields we need for the All Farms table)
    async function saveSchedule3FarmDetailsToFirebase(fd) {
      const dairyNumber = fd.get("dairy-number") || "";
      if (!dairyNumber) return;
      // Get basic farm details
      const farmDetails = {
        dairyCompany: fd.get("dairy-company") || "",
        address: fd.get("address") || "",
        customerName: fd.get("customer-name") || "",
        region: fd.get("region") || "",
        farmName: fd.get("farm-name") || "",
        island: fd.get("island") || "",
        installDate: fd.get("install-date") || "",
        replacementDue: fd.get("replacement-due") || ""
      };
      // Also include the checklist extra fields from the form data saved in Dexie
      const record = await db.schedule3Forms.get(dairyNumber);
      if (record && record.formData && record.formData.checklistItems) {
        // For each checklist item, extract the desired fields for display in the All Farms table
        const checklistForDisplay = [];
        for (const [itemName, details] of Object.entries(record.formData.checklistItems)) {
          checklistForDisplay.push({
            itemName,
            quantity: details.quantity || "",
            size: details.size || "",
            itemInstall: details.itemInstall || "",
            expiryDate: details.expiryDate || ""
          });
        }
        farmDetails.checklistItems = checklistForDisplay;
      }
      const jsonBlob = new Blob([JSON.stringify(farmDetails)], { type: "application/json" });
      try {
        const storageRefFarm = storage.ref(`Agora schedule 3 farm details/${dairyNumber}.json`);
        await storageRefFarm.put(jsonBlob);
        console.log("Schedule 3 farm details JSON saved.");
      } catch (err) {
        console.error("Error saving Schedule 3 farm details JSON:", err);
      }
    }
    
    async function uploadPendingPDFs() {
      if (!navigator.onLine) return;
      const queuedPDFs = await db.pdfQueue.toArray();
      for (let pdfRecord of queuedPDFs) {
        if(pdfRecord.target === "schedule3"){
          try{
            await uploadSinglePDFSchedule3(pdfRecord.dairyNumber, pdfRecord.fileName, pdfRecord.pdfBlob);
            await db.pdfQueue.delete(pdfRecord.id);
            console.log(`Retried PDF for ${pdfRecord.dairyNumber} uploaded successfully (Schedule3).`);
          } catch(err){ console.error("Retry PDF upload (Schedule3) failed:", err); }
        }
      }
    }
    
    function uploadSinglePDFSchedule3(dairyNumber, fileName, pdfBlob) {
      return new Promise((resolve, reject) => {
        const uploadRef = storage.ref(`Agora schedule 3 Customers/${dairyNumber}/${fileName}`);
        const task = uploadRef.put(pdfBlob);
        task.on("state_changed", null, err => reject(err), () => resolve());
      });
    }
    
    window.addEventListener("online", uploadPendingPDFs);
    
    async function generatePDFSchedule3() {
      const dairyNumber = document.getElementById("dairy-number").value.trim();
      if (!dairyNumber) { alert("Please enter a Dairy Number."); return; }
      const form = document.getElementById("schedule3-form");
      const fd = new FormData(form);
      // Save farm details (including checklist extra fields) to Firebase
      await saveSchedule3FarmDetailsToFirebase(fd);
      // Also save the form data in Dexie
      await saveSchedule3FormData();
      
      // Prepare PDF content (this example reuses checklistData from form)
      const checklistContainers = document.getElementById("checklist-items").children;
      const checklistData = [];
      let imagePromises = [];
      let photoStore = [];
      for (let item of checklistContainers) {
        const labelEl = item.querySelector("label");
        if (!labelEl) continue;
        const itemName = labelEl.textContent;
        const sanitized = itemName.replace(/\s+/g, "_").toLowerCase();
        const status = item.querySelector(`select[name="status-${sanitized}"]`)?.value || "";
        let comments = item.querySelector(`input[name="comments-${sanitized}"]`)?.value || "";
        const rubberware = item.querySelector(`input[name="rubberware-${sanitized}"]`)?.value || "";
        const quantity = item.querySelector(`input[name="quantity-${sanitized}"]`)?.value || "";
        const size = item.querySelector(`input[name="size-${sanitized}"]`)?.value || "";
        const itemInstall = item.querySelector(`input[name="item-install-${sanitized}"]`)?.value || "";
        const expiryDate = item.querySelector(`input[name="expiry-date-${sanitized}"]`)?.value || "";
        const fileInputs = item.querySelectorAll("input[type='file']");
        let images = [];
        fileInputs.forEach(inp => {
          if (inp.files && inp.files[0]) { images.push(inp.files[0]); }
        });
        if (status === "attention-required" && images.length > 0) {
          const photoNote = images.length > 1 ? " (see attached photos)" : " (see attached photo)";
          comments += photoNote;
          const p = { itemName, images: [] };
          images.forEach((file, idx) => {
            imagePromises.push(convertFileToBase64(file).then(result => { p.images[idx] = result; }));
          });
          photoStore.push(p);
        }
        // For PDF, include the extra fields in the checklist row
        checklistData.push([itemName, quantity, size, itemInstall, expiryDate]);
      }
      
      // Basic farm details for the PDF header
      const farmDetailsRows = [
        [
          { content: "Dairy Company:", styles: { fontStyle: "bold" } },
          { content: (fd.get("dairy-company") || ""), styles: { fontStyle: "normal" } },
          { content: "Visit Type:", styles: { fontStyle: "bold" } },
          { content: (fd.get("visit-type") || ""), styles: { fontStyle: "normal" } }
        ],
        [
          { content: "Dairy Number:", styles: { fontStyle: "bold" } },
          { content: (fd.get("dairy-number") || ""), styles: { fontStyle: "normal" } },
          { content: "Install Date:", styles: { fontStyle: "bold" } },
          { content: (fd.get("install-date") || ""), styles: { fontStyle: "normal" } }
        ],
        [
          { content: "Address:", styles: { fontStyle: "bold" } },
          { content: (fd.get("address") || ""), styles: { fontStyle: "normal" } },
          { content: "Replacement Due:", styles: { fontStyle: "bold" } },
          { content: (fd.get("replacement-due") || ""), styles: { fontStyle: "normal" } }
        ],
        [
          { content: "Customer Name:", styles: { fontStyle: "bold" } },
          { content: (fd.get("customer-name") || ""), styles: { fontStyle: "normal" } },
          { content: "Rubberware Details:", styles: { fontStyle: "bold" } },
          { content: "See checklist items", styles: { fontStyle: "normal" } }
        ]
      ];
      
      Promise.all(imagePromises).then(() => {
        finalizePDF();
      }).catch(() => {
        finalizePDF();
      });
      
      function finalizePDF() {
        const pdf = new jsPDF("p", "pt", "a4");
        let currentY = 40;
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        storage.ref("Agora Logo/2F6-1YdaEP.jpeg").getDownloadURL().then(url => {
          fetch(url)
            .then(res => res.blob())
            .then(blob => convertFileToBase64(blob))
            .then(logoBase64 => {
              const img = new Image();
              img.onload = function() {
                const fixedLogoWidth = 150;
                const fixedLogoHeight = (img.height * fixedLogoWidth) / img.width;
                const x = (pageWidth - fixedLogoWidth) / 2;
                pdf.addImage(logoBase64, "JPEG", x, 40, fixedLogoWidth, fixedLogoHeight);
                currentY = 40 + fixedLogoHeight + 20;
                addFarmDetailsAndTables(pdf);
              };
              img.src = logoBase64;
            })
            .catch(err => {
              console.error("Logo error:", err);
              addFarmDetailsAndTables(pdf);
            });
        }).catch(err => {
          console.error("Logo error:", err);
          addFarmDetailsAndTables(pdf);
        });
        
        function addFarmDetailsAndTables(pdf) {
          pdf.autoTable({
            startY: currentY,
            head: [["Farm Details", "", "", ""]],
            body: farmDetailsRows,
            theme: 'grid',
            styles: { fontSize: 10, cellPadding: 5 },
            headStyles: { fillColor: "#002B5C", textColor: "#fff" },
            margin: { left: 40, right: 40 }
          });
          currentY = pdf.lastAutoTable.finalY + 20;
          
          pdf.setFont("helvetica", "bold");
          pdf.text("Checklist Items (Rubberware Data):", 40, currentY);
          currentY += 10;
          pdf.autoTable({
            startY: currentY,
            head: [["Item Name", "Quantity", "Size", "Item Install Date", "Expiry Date"]],
            body: checklistData,
            styles: { fontSize: 10, cellPadding: 5 },
            headStyles: { fillColor: "#002B5C", textColor: "#fff" },
            margin: { left: 40, right: 40 }
          });
          currentY = pdf.lastAutoTable.finalY + 20;
          
          if (photoStore.length > 0) {
            pdf.setFont("helvetica", "bold");
            if (currentY + 20 > pageHeight) {
              pdf.addPage();
              currentY = 40;
            }
            pdf.text("Attached Photos:", 40, currentY);
            currentY += 20;
            photoStore.forEach(photoItem => {
              if (currentY + 15 > pageHeight) {
                pdf.addPage();
                currentY = 40;
              }
              pdf.setFont("helvetica", "bold");
              pdf.text(photoItem.itemName, 40, currentY);
              currentY += 15;
              let maxImgHeight = 0;
              photoItem.images.forEach((img, idx) => {
                try {
                  const imgProps = pdf.getImageProperties(img);
                  const imgWidth = 250;
                  const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
                  if (currentY + imgHeight > pageHeight) {
                    pdf.addPage();
                    currentY = 40;
                  }
                  pdf.addImage(img, "JPEG", 40 + idx * (imgWidth + 10), currentY, imgWidth, imgHeight);
                  if (imgHeight > maxImgHeight) maxImgHeight = imgHeight;
                } catch(e) {
                  console.error("Error adding image:", e);
                }
              });
              currentY += maxImgHeight + 20;
            });
          }
          
          (async function(){
            const pdfBlob = pdf.output("blob");
            const visitDate = fd.get("visit-date");
            if (!visitDate) {
              alert("Visit Date is required.");
              return;
            }
            const dateParts = visitDate.split("-");
            const formattedVisitDate = dateParts[2] + "-" + dateParts[1] + "-" + dateParts[0].substr(2);
            const fileName = `${fd.get("dairy-number")}-schedule3-${formattedVisitDate}.pdf`;
            try {
              await uploadSinglePDFSchedule3(dairyNumber, fileName, pdfBlob);
              console.log("Schedule 3 PDF uploaded successfully");
            } catch(e) {
              console.error("PDF upload failed:", e);
              db.pdfQueue.add({ dairyNumber, fileName, pdfBlob, uploaded: false, target: "schedule3" });
            }
            db.schedule3Forms.delete(fd.get("dairy-number"));
            pdf.save(fileName);
            uploadPendingPDFs();
            clearEntireFormSchedule3();
            location.reload();
          })();
        }
      }
    }
    
    /* VIEW RECORDS (Schedule 3) */
    function viewRecordsSchedule3() {
      document.getElementById("form-container").style.display = "none";
      document.getElementById("all-farms-container").style.display = "none";
      document.getElementById("record-container").style.display = "block";
      loadAllRecordsSchedule3();
    }
    
    async function loadAllRecordsSchedule3() {
      const recordList = document.getElementById("record-list");
      recordList.innerHTML = "";
      const storageRef = storage.ref("Agora schedule 3 Customers");
      try {
        const folderSnapshot = await storageRef.listAll();
        // List folders (each dairy number)
        if (folderSnapshot.prefixes.length > 0) {
          folderSnapshot.prefixes.forEach(folderRef => {
            const dairyNumber = folderRef.name;
            const link = document.createElement("a");
            link.textContent = dairyNumber;
            link.href = "#";
            link.style.display = "block";
            link.addEventListener("click", () => loadRecordFilesSchedule3(dairyNumber));
            recordList.appendChild(link);
          });
        }
        // List any files directly in the folder
        if (folderSnapshot.items.length > 0) {
          folderSnapshot.items.forEach(fileRef => {
            const fileName = fileRef.name;
            const link = document.createElement("a");
            link.textContent = fileName;
            link.href = "#";
            link.style.display = "block";
            link.addEventListener("click", async () => {
              try {
                const url = await fileRef.getDownloadURL();
                window.open(url, "_blank");
              } catch (err) {
                console.error("Error fetching file:", err);
              }
            });
            recordList.appendChild(link);
          });
        }
        if(recordList.innerHTML === ""){
          recordList.innerHTML = "<p>No Schedule 3 records found.</p>";
        }
      } catch (error) {
        console.error("Error fetching Schedule3 records:", error);
      }
    }
    
    async function loadRecordFilesSchedule3(dairyNumber) {
      const recordList = document.getElementById("record-list");
      recordList.innerHTML = "";
      const folderRef = storage.ref(`Agora schedule 3 Customers/${dairyNumber}`);
      try {
        const fileSnapshot = await folderRef.listAll();
        fileSnapshot.items.forEach(fileRef => {
          const fileName = fileRef.name;
          const dateMatch = fileName.match(/(\d{4}-\d{2}-\d{2})/);
          const displayName = dateMatch ? dateMatch[0] : fileName;
          const fileLink = document.createElement("a");
          fileLink.textContent = displayName;
          fileLink.href = "#";
          fileLink.style.display = "block";
          fileLink.addEventListener("click", async () => {
            try {
              const url = await fileRef.getDownloadURL();
              window.open(url, "_blank");
            } catch (err) {
              console.error("Error fetching file:", err);
            }
          });
          recordList.appendChild(fileLink);
        });
        const backBtn = document.createElement("button");
        backBtn.textContent = "Back to Records";
        backBtn.className = "back-button";
        backBtn.addEventListener("click", loadAllRecordsSchedule3);
        recordList.appendChild(backBtn);
      } catch (err) {
        console.error("Error fetching record files:", err);
      }
    }
    
    function filterRecordsSchedule3() {
      const searchValue = document.getElementById("search-dairy-number").value.toLowerCase();
      const recordList = document.getElementById("record-list");
      const links = recordList.getElementsByTagName("a");
      for (let i = 0; i < links.length; i++) {
        const txt = links[i].textContent || links[i].innerText;
        links[i].style.display = txt.toLowerCase().includes(searchValue) ? "" : "none";
      }
    }
    
    function goBackSchedule3() {
      document.getElementById("record-container").style.display = "none";
      document.getElementById("form-container").style.display = "block";
    }
    
    /* ALL FARMS VIEW: Build a table with columns:
       Dairy Number / Item Name / Item Size / Item Quantity / Item Install Date / Expiry Date */
    async function loadAllFarms() {
      const farmsGrid = document.getElementById("farms-grid");
      farmsGrid.innerHTML = ""; // Clear existing content
      const storageRef = storage.ref("Agora schedule 3 farm details");
      try {
        const allFiles = await getAllFarmFiles(storageRef);
        if(allFiles.length === 0) {
          farmsGrid.innerHTML = "<p>No farms found.</p>";
          return;
        }
        // Create a table element
        const table = document.createElement("table");
        const thead = document.createElement("thead");
        const headerRow = document.createElement("tr");
        ["Dairy Number", "Item Name", "Item Size", "Item Quantity", "Item Install Date", "Expiry Date"].forEach(text => {
          const th = document.createElement("th");
          th.textContent = text;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);
        const tbody = document.createElement("tbody");
        // For each file, load JSON and extract checklistItems for display
        const promises = allFiles.map(async fileRef => {
          try {
            const url = await fileRef.getDownloadURL();
            const response = await fetch(url);
            const data = await response.json();
            const dairyNumber = fileRef.name.endsWith(".json") ? fileRef.name.replace(".json", "") : fileRef.name;
            if (data.checklistItems && Array.isArray(data.checklistItems)) {
              // If checklistItems is an array (as saved in our update function)
              return data.checklistItems.map(item => ({ dairyNumber, ...item }));
            } else if (data.checklistItems && typeof data.checklistItems === "object") {
              // If stored as object keyed by item name, convert to array
              return Object.entries(data.checklistItems).map(([itemName, details]) => ({
                dairyNumber,
                itemName,
                quantity: details.quantity || "",
                size: details.size || "",
                itemInstall: details.itemInstall || "",
                expiryDate: details.expiryDate || ""
              }));
            } else {
              return [];
            }
          } catch(e) {
            console.error("Error loading farm details:", e);
            return [];
          }
        });
        const farmsArrays = await Promise.all(promises);
        const allRows = farmsArrays.flat();
        allRows.forEach(row => {
          const tr = document.createElement("tr");
          const tdDairy = document.createElement("td");
          tdDairy.textContent = row.dairyNumber;
          tr.appendChild(tdDairy);
          const tdItemName = document.createElement("td");
          tdItemName.textContent = row.itemName || "";
          tr.appendChild(tdItemName);
          const tdSize = document.createElement("td");
          tdSize.textContent = row.size || "";
          tr.appendChild(tdSize);
          const tdQuantity = document.createElement("td");
          tdQuantity.textContent = row.quantity || "";
          tr.appendChild(tdQuantity);
          const tdInstall = document.createElement("td");
          tdInstall.textContent = row.itemInstall || "";
          tr.appendChild(tdInstall);
          const tdExpiry = document.createElement("td");
          tdExpiry.textContent = row.expiryDate || "";
          tr.appendChild(tdExpiry);
          tbody.appendChild(tr);
        });
        table.appendChild(tbody);
        farmsGrid.appendChild(table);
      } catch (error) {
        console.error("Error loading all farms:", error);
      }
    }
    
    // Helper: Recursively get files from a storage reference (including subfolders)
    async function getAllFarmFiles(storageRef) {
      let allFiles = [];
      try {
        const listResult = await storageRef.listAll();
        allFiles = allFiles.concat(listResult.items);
        for (const prefix of listResult.prefixes) {
          const subResult = await prefix.listAll();
          allFiles = allFiles.concat(subResult.items);
        }
      } catch (err) {
        console.error("Error listing farm files:", err);
      }
      return allFiles;
    }
    
    function showAllFarms() {
      document.getElementById("form-container").style.display = "none";
      document.getElementById("record-container").style.display = "none";
      document.getElementById("all-farms-container").style.display = "block";
      loadAllFarms();
    }
    
    function backToFormSchedule3() {
      document.getElementById("all-farms-container").style.display = "none";
      document.getElementById("form-container").style.display = "block";
    }
    
    function filterRecordsSchedule3() {
      const searchValue = document.getElementById("search-dairy-number").value.toLowerCase();
      const recordList = document.getElementById("record-list");
      const links = recordList.getElementsByTagName("a");
      for (let i = 0; i < links.length; i++) {
        const txt = links[i].textContent || links[i].innerText;
        links[i].style.display = txt.toLowerCase().includes(searchValue) ? "" : "none";
      }
    }
    
    function goBackSchedule3() {
      document.getElementById("record-container").style.display = "none";
      document.getElementById("form-container").style.display = "block";
    }
    
    document.addEventListener("DOMContentLoaded", async () => {
      const fieldsToAutoCap = ["dairy-number", "dairy-company", "address", "customer-name", "farm-name"];
      fieldsToAutoCap.forEach(autoCapitalizeInput);
      await setupDairyCompanyDatalist();
      createChecklistItemsSchedule3();
      const form = document.getElementById("schedule3-form");
      form.addEventListener("input", saveSchedule3FormData);
      form.addEventListener("change", saveSchedule3FormData);
      uploadPendingPDFs();
    });
  </script>
</body>
</html>