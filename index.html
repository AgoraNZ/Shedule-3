<!DOCTYPE html>
<html lang="en">
<head>
  <!-- META & STYLES -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agora Schedule 3</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
  <style>
    body {
      background-color: #d2d7dd;
      font-family: Arial, sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      margin: 0;
    }
    .container, .change-dates-container {
      background-color: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      max-width: 800px;
      width: 100%;
    }
    h1, h2, h3 { text-align: center; }
    button {
      background-color: #FFD700;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      margin: 10px 5px;
      border-radius: 5px;
    }
    .back-button { background-color: #002B5C; color: #fff; }
    .change-dates-container {
      display: none;
      padding: 20px;
    }
    .farm-box {
      background: #f8f9fa;
      border: 1px solid #ddd;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 5px;
    }
    .farm-box h4 { margin-bottom: 10px; }
    .checklist-item { margin-bottom: 15px; }
  </style>
</head>
<body>

  <!-- MAIN FORM -->
  <div class="container" id="form-container">
    <h1>Agora Schedule 3</h1>
    <button onclick="changeSchedule3Dates()">Change Dates</button>
  </div>

  <!-- CHANGE DATES FEATURE (Like Pilot Checks) -->
  <div id="change-dates-container" class="change-dates-container">
    <h2>Schedule 3 Farm Details</h2>
    <div id="farms-list"></div>
    <button class="back-button" onclick="backToForm()">Back to Form</button>
  </div>

  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
  <script>
    // Firebase Initialization
    const firebaseConfig = {
      apiKey: "AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
      authDomain: "dairy-farm-record-system.firebaseapp.com",
      projectId: "dairy-farm-record-system",
      storageBucket: "dairy-farm-record-system.appspot.com",
      messagingSenderId: "422124188212",
      appId: "1:422124188212:web:1bd31bee8d6e91e301d061"
    };
    firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();

    // Function to Open Change Dates Screen
    function changeSchedule3Dates() {
      document.getElementById("form-container").style.display = "none";
      document.getElementById("change-dates-container").style.display = "block";
      loadSchedule3Farms();
    }

    // Function to Load All Farms with Schedule 3 Details
    async function loadSchedule3Farms() {
      const farmsList = document.getElementById("farms-list");
      farmsList.innerHTML = "<p>Loading farm details...</p>";

      const folderRef = storage.ref("Agora schedule 3 farm details");
      try {
        const snapshot = await folderRef.listAll();
        farmsList.innerHTML = "";
        if (snapshot.items.length > 0) {
          for (const fileRef of snapshot.items) {
            try {
              const url = await fileRef.getDownloadURL();
              const res = await fetch(url);
              const data = await res.json();
              createFarmBox(data, fileRef.name);
            } catch (e) {
              console.error("Error loading farm:", fileRef.name, e);
            }
          }
        } else {
          farmsList.innerHTML = "<p>No Schedule 3 farm details found.</p>";
        }
      } catch (error) {
        console.error("Error fetching Schedule 3 farm details:", error);
        farmsList.innerHTML = "<p>Error fetching Schedule 3 farm details.</p>";
      }
    }

    // Function to Create Farm Box (Styled Like Pilot Checks)
    function createFarmBox(data, fileName) {
      const farmsList = document.getElementById("farms-list");

      const farmBox = document.createElement("div");
      farmBox.classList.add("farm-box");

      farmBox.innerHTML = `
        <h4>${data.farmName || "Unknown Farm"}</h4>
        <p><strong>Dairy Number:</strong> ${fileName.replace(".json", "")}</p>
        <p><strong>Dairy Company:</strong> ${data.dairyCompany || "N/A"}</p>
      `;

      // Checklist Items Section
      if (data.checklistExtra) {
        for (const key in data.checklistExtra) {
          const itemData = data.checklistExtra[key];

          const itemDiv = document.createElement("div");
          itemDiv.classList.add("checklist-item");

          itemDiv.innerHTML = `
            <strong>${key}</strong><br>
            <label>Install Date:</label> 
            <input type="date" class="form-control" value="${itemData.installDate || ""}" data-field="installDate" data-key="${key}" data-file="${fileName}">
            <label>Replacement Due:</label> 
            <input type="date" class="form-control" value="${itemData.replacementDue || ""}" data-field="replacementDue" data-key="${key}" data-file="${fileName}">
            <label>Rubberware Size:</label> 
            <input type="text" class="form-control" value="${itemData.rubberwareSize || ""}" data-field="rubberwareSize" data-key="${key}" data-file="${fileName}">
          `;

          farmBox.appendChild(itemDiv);
        }
      }

      const saveButton = document.createElement("button");
      saveButton.textContent = "Save Changes";
      saveButton.onclick = () => saveFarmChanges(fileName);
      farmBox.appendChild(saveButton);

      farmsList.appendChild(farmBox);
    }

    // Function to Save Changes to Firebase
    async function saveFarmChanges(fileName) {
      const inputs = document.querySelectorAll(`[data-file='${fileName}']`);
      let updatedData = {};

      inputs.forEach(input => {
        const key = input.dataset.key;
        const field = input.dataset.field;
        if (!updatedData[key]) updatedData[key] = {};
        updatedData[key][field] = input.value;
      });

      // Fetch existing farm data
      const fileRef = storage.ref(`Agora schedule 3 farm details/${fileName}`);
      try {
        const url = await fileRef.getDownloadURL();
        const res = await fetch(url);
        let farmData = await res.json();
        farmData.checklistExtra = updatedData;
        
        // Upload updated data
        const jsonBlob = new Blob([JSON.stringify(farmData)], { type: "application/json" });
        await fileRef.put(jsonBlob);
        alert("Changes saved successfully!");
      } catch (error) {
        console.error("Error saving changes:", error);
        alert("Failed to save changes.");
      }
    }

    // Function to Return to Form
    function backToForm() {
      document.getElementById("change-dates-container").style.display = "none";
      document.getElementById("form-container").style.display = "block";
    }
  </script>
</body>
</html>