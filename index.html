from fpdf import FPDF
from datetime import datetime

# Checklist data (from the first code) for each farm.
# Each checklist item includes all details: sizes, quantity, expiry, install, etc.
checklist_data = {
    "Farm 1": [
        {
            "item": "Fire Extinguishers",
            "sizes": "9kg",
            "quantity": 2,
            "expiry": "11/2025",
            "install": "05/2021"
        },
        {
            "item": "First Aid Kits",
            "sizes": "Large",
            "quantity": 1,
            "expiry": "07/2024",
            "install": "N/A"
        },
        {
            "item": "Ladders",
            "sizes": "2m",
            "quantity": 2,
            "expiry": "N/A",
            "install": "03/2018"
        },
        {
            "item": "Safety Signage",
            "sizes": "Standard",
            "quantity": 4,
            "expiry": "N/A",
            "install": "06/2019"
        }
    ],
    "Farm 2": [
        {
            "item": "Fire Extinguishers",
            "sizes": "9kg",
            "quantity": 1,
            "expiry": "05/2024",
            "install": "08/2019"
        },
        {
            "item": "First Aid Kits",
            "sizes": "Large",
            "quantity": 1,
            "expiry": "09/2025",
            "install": "01/2020"
        },
        {
            "item": "Ladders",
            "sizes": "3m",
            "quantity": 1,
            "expiry": "N/A",
            "install": "07/2020"
        },
        {
            "item": "Safety Signage",
            "sizes": "Standard",
            "quantity": 3,
            "expiry": "N/A",
            "install": "05/2018"
        }
    ],
    "Farm 3": [
        {
            "item": "Fire Extinguishers",
            "sizes": "9kg",
            "quantity": 3,
            "expiry": "08/2026",
            "install": "04/2021"
        },
        {
            "item": "First Aid Kits",
            "sizes": "Large",
            "quantity": 2,
            "expiry": "12/2024",
            "install": "03/2021"
        },
        {
            "item": "Ladders",
            "sizes": "2.5m",
            "quantity": 2,
            "expiry": "N/A",
            "install": "09/2019"
        },
        {
            "item": "Safety Signage",
            "sizes": "Standard",
            "quantity": 5,
            "expiry": "N/A",
            "install": "02/2022"
        }
    ]
}

def generate_checklist_pdf(selected_farm):
    """Generate a checklist PDF for the selected farm or all farms."""
    pdf = FPDF()
    pdf.set_auto_page_break(auto=True, margin=15)
    
    if selected_farm != "All Farms":
        # Single farm PDF generation
        pdf.add_page()
        # Place the logo at the original coordinates (logo placement unchanged)
        try:
            pdf.image("logo.png", 10, 8, 33)  # Use the same file path/coords as in original code
        except Exception:
            pass  # If logo file not found or error, skip to avoid breaking execution
        # Title (farm name) centered at top
        pdf.set_font("Arial", 'B', 16)
        pdf.cell(0, 10, f"{selected_farm} Checklist", ln=1, align='C')
        pdf.ln(5)
        # Checklist items with details
        pdf.set_font("Arial", '', 12)
        for item in checklist_data.get(selected_farm, []):
            # Main checklist item with a checkbox placeholder
            pdf.cell(0, 8, f"[ ] {item['item']}", ln=1)
            # Details (sizes, quantity, expiry, install) in indented sub-lines
            pdf.set_font("Arial", '', 11)
            pdf.cell(0, 6, f"   Sizes: {item['sizes']}", ln=1)
            pdf.cell(0, 6, f"   Quantity: {item['quantity']}", ln=1)
            pdf.cell(0, 6, f"   Expiry: {item['expiry']}", ln=1)
            pdf.cell(0, 6, f"   Install: {item['install']}", ln=1)
            pdf.ln(4)  # small spacing after each item block
            pdf.set_font("Arial", '', 12)  # reset font for next item
    else:
        # "All Farms" combined PDF generation
        pdf.add_page()
        try:
            pdf.image("logo.png", 10, 8, 33)
        except Exception:
            pass
        pdf.set_font("Arial", 'B', 16)
        pdf.cell(0, 10, "All Farms - Combined Checklist", ln=1, align='C')
        pdf.ln(5)
        # Loop through each farm and list its items
        farm_count = len(checklist_data)
        current_index = 0
        for farm, items in checklist_data.items():
            current_index += 1
            # Farm name subheading
            pdf.set_font("Arial", 'B', 14)
            pdf.cell(0, 8, farm, ln=1)
            pdf.set_font("Arial", '', 12)
            for item in items:
                pdf.cell(0, 8, f"[ ] {item['item']}", ln=1)
                pdf.set_font("Arial", '', 11)
                pdf.cell(0, 6, f"   Sizes: {item['sizes']}", ln=1)
                pdf.cell(0, 6, f"   Quantity: {item['quantity']}", ln=1)
                pdf.cell(0, 6, f"   Expiry: {item['expiry']}", ln=1)
                pdf.cell(0, 6, f"   Install: {item['install']}", ln=1)
                pdf.ln(4)
                pdf.set_font("Arial", '', 12)
            # Start each farm's list on a new page (except after the last farm)
            if current_index < farm_count:
                pdf.add_page()
                try:
                    pdf.image("logo.png", 10, 8, 33)
                except Exception:
                    pass
                pdf.ln(5)
    # Save PDF following original naming conventions (include farm name and date)
    date_str = datetime.now().strftime("%d-%m-%Y")
    farm_label = selected_farm.replace(" ", "_")
    filename = f"{farm_label}_Checklist_{date_str}.pdf"
    file_path = f"/mnt/data/{filename}"
    pdf.output(file_path)
    return file_path

# Example usage:
if __name__ == "__main__":
    # Select a farm or use "All Farms"
    selected_farm = "All Farms"
    if selected_farm != "All Farms" and selected_farm not in checklist_data:
        print(f"Invalid farm selection. Available farms: {', '.join(checklist_data.keys())} or 'All Farms'.")
    else:
        output_file = generate_checklist_pdf(selected_farm)
        print(f"Checklist PDF generated: {output_file}")