<!DOCTYPE html>
<html lang="en">
<head>
  <!-- META & STYLES -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Agora Reporting Form</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css">
  <style>
    /* Overall background and common styling */
    body {
      background-color: #d2d7dd;
      color: #000;
      font-family: Arial, sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      margin: 0;
    }
    .container, .record-container {
      background-color: #d2d7dd;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
      max-width: 800px;
      width: 100%;
    }
    .record-container {
      background-color: #fff;
    }
    h1, h2, h3, h4 { text-align: center; }
    h1, h2 { color: #333; }
    h3 { color: #002B5C; margin-top: 20px; }
    h4 { color: #555; margin-top: 10px; }
    label { color: #000; margin-top: 10px; }
    button {
      background-color: #FFD700;
      color: #000;
      border: none;
      padding: 10px 20px;
      cursor: pointer;
      display: inline-block;
      margin: 10px 5px;
      border-radius: 5px;
    }
    button:hover { background-color: #E6C200; }
    .back-button { background-color: #002B5C; color: #fff; }
    .image-upload { display: none; }
    .image-preview {
      display: none;
      max-width: 200px;
      max-height: 200px;
      margin-top: 5px;
      border: 2px solid #ccc;
    }
    .calibration-container,
    .temp-extra-container { display: none; margin-top: 10px; padding: 10px; border: 1px dashed #888; }
    /* Pilot Checks Page Styling */
    .pilot-checks-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around;
    }
    .farm-checks {
      background-color: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 5px;
      margin: 10px;
      padding: 15px;
      width: 45%;
      min-width: 280px;
    }
    .farm-checks ul {
      list-style: none;
      padding: 0;
    }
    .farm-checks li {
      padding: 5px 0;
      border-bottom: 1px solid #ddd;
    }
    .farm-checks li:last-child {
      border-bottom: none;
    }
    .version { text-align: center; margin-top: 20px; color: #333; font-size: 12px; }
  </style>
</head>
<body>
  <!-- MAIN FORM CONTAINER -->
  <!-- Note: The form id has been changed to "schedule3-form" so that the new checklist functions and save/clear functions work correctly. -->
  <div class="container" id="form-container">
    <img src="https://firebasestorage.googleapis.com/v0/b/dairy-farm-record-system.appspot.com/o/Agora%20Logo%2F2F6-1YdaEP.jpeg?alt=media" alt="Logo" class="logo" style="display:block; margin: 0 auto 20px; width:250px;">
    <h1>Agora Reporting Form</h1>
    <form id="schedule3-form">
      <!-- Farm Details Section -->
      <div class="section mb-4">
        <h2>Farm Details</h2>
        <label for="dairy-number">Dairy Number:</label>
        <input type="text" class="form-control" id="dairy-number" name="dairy-number" onblur="handleDairyNumberBlur();" autocapitalize="words" autocorrect="on" spellcheck="false">
        <label for="dairy-company">Dairy Company:</label>
        <input type="text" class="form-control" id="dairy-company" name="dairy-company" list="dairy-company-list" placeholder="Type or select..." autocapitalize="words" autocorrect="on" spellcheck="false">
        <datalist id="dairy-company-list"></datalist>
        <label for="address">Address:</label>
        <input type="text" class="form-control" id="address" name="address" autocapitalize="words" autocorrect="on" spellcheck="false">
        <label for="customer-name">Customer Name:</label>
        <input type="text" class="form-control" id="customer-name" name="customer-name" autocapitalize="words" autocorrect="on" spellcheck="false">
        <label for="region">Region:</label>
        <select id="region" name="region" class="form-select">
          <option value="northland">Northland</option>
          <option value="auckland">Auckland</option>
          <option value="waikato">Waikato</option>
          <option value="bay-of-plenty">Bay of Plenty</option>
          <option value="gisborne">Gisborne</option>
          <option value="hawkes-bay">Hawke's Bay</option>
          <option value="taranaki">Taranaki</option>
          <option value="manawatu-wanganui">Manawatu-Wanganui</option>
          <option value="wellington">Wellington</option>
          <option value="nelson">Nelson</option>
          <option value="marlborough">Marlborough</option>
          <option value="west-coast">West Coast</option>
          <option value="canterbury">Canterbury</option>
          <option value="otago">Otago</option>
          <option value="southland">Southland</option>
        </select>
        <label for="farm-name">Farm Name:</label>
        <input type="text" class="form-control" id="farm-name" name="farm-name" autocapitalize="words" autocorrect="on" spellcheck="false">
        <label for="island">Island:</label>
        <select id="island" name="island" class="form-select">
          <option value="north-island">North Island</option>
          <option value="south-island">South Island</option>
        </select>
        <label for="visit-date">Visit Date:</label>
        <input type="date" class="form-control" id="visit-date" name="visit-date">
        <label for="visit-type">Visit Type:</label>
        <input type="text" class="form-control" id="visit-type" name="visit-type" value="Milking Plant & Milk Vat Check" readonly autocapitalize="words" autocorrect="on" spellcheck="false">
        <label for="inspection-start-time">Inspection Start Time:</label>
        <input type="time" class="form-control" id="inspection-start-time" name="inspection-start-time">
        <label for="inspection-end-time">Inspection End Time:</label>
        <input type="time" class="form-control" id="inspection-end-time" name="inspection-end-time">
        <label for="inspection-completed-by">Inspection Completed By:</label>
        <input type="text" class="form-control" id="inspection-completed-by" name="inspection-completed-by" autocapitalize="words" autocorrect="on" spellcheck="false">
        <label for="call-type">Call Type:</label>
        <select id="call-type" name="call-type" class="form-select">
          <option value="alert">Alert</option>
          <option value="grade-call">Grade Call</option>
          <option value="regular-scheduled-visit" selected>Regular Scheduled Visit</option>
        </select>
      </div>
      
      <!-- Health & Safety Section -->
      <div class="section mb-4">
        <h2>Health & Safety</h2>
        <div id="health-safety-top"></div>
      </div>
      
      <!-- Schedule3 Checklist Section -->
      <div class="section mb-4">
        <h2>Schedule 3 Checklist</h2>
        <div id="checklist-items"></div>
      </div>
      
      <!-- Silo Checklist Section -->
      <div class="section mb-4">
        <h2>Silo Checklist</h2>
        <div id="silo-checklist"></div>
      </div>
      
      <!-- Temperature Measurement Section -->
      <div class="section mb-4" id="temp-measurement-section">
        <h2>Temperature Measurement</h2>
        <div class="mb-3">
          <label for="hot-water-temp">Hot Water Temp (°C):</label>
          <input type="text" class="form-control" id="hot-water-temp" name="hot-water-temp" autocorrect="on">
        </div>
        <div class="mb-3">
          <label for="hot-water-time">Time Taken:</label>
          <input type="time" class="form-control" id="hot-water-time" name="hot-water-time" placeholder="--:-- --">
        </div>
        <div class="mb-3">
          <label for="milk-temp">Milk Temp (°C):</label>
          <input type="text" class="form-control" id="milk-temp" name="milk-temp" autocorrect="on">
        </div>
        <div class="mb-3">
          <label for="milk-time">Time Taken:</label>
          <input type="time" class="form-control" id="milk-time" name="milk-time" placeholder="--:-- --">
        </div>
      </div>
      
      <!-- New Temperature Sensors Section -->
      <div class="section mb-4" id="temperature-sensors-container">
        <h2>Temperature Sensors</h2>
      </div>
      
      <!-- Flow Meters Section -->
      <div class="section mb-4" id="flow-meters-section">
        <h2>Flow Meters</h2>
        <!-- Acid Flow Meter -->
        <div class="flow-meter-item checklist-item">
          <h3>Acid Flow Meter</h3>
          <label for="acid-flow-physical">Physical Test (ml):</label>
          <input type="number" class="form-control" id="acid-flow-physical" name="acid-flow-physical">
          <label for="acid-flow-system">System Read (ml):</label>
          <input type="number" class="form-control" id="acid-flow-system" name="acid-flow-system">
          <div class="calibration-container" id="acid-calibration">
            <label for="acid-pulse-old">Pulse per ml Old:</label>
            <input type="number" step="0.01" class="form-control" id="acid-pulse-old" name="acid-pulse-old">
            <label for="acid-pulse-new">Pulse per ml New:</label>
            <input type="number" step="0.01" class="form-control" id="acid-pulse-new" name="acid-pulse-new">
            <label for="acid-new-test-physical">New Test Physical (ml):</label>
            <input type="number" class="form-control" id="acid-new-test-physical" name="acid-new-test-physical">
            <label for="acid-new-system-result">New System Result (ml):</label>
            <input type="number" class="form-control" id="acid-new-system-result" name="acid-new-system-result">
          </div>
        </div>
        <!-- Chlor Alkali Flow Meter -->
        <div class="flow-meter-item checklist-item">
          <h3>Chlor Alkali Flow Meter</h3>
          <label for="chlor-flow-physical">Physical Test (ml):</label>
          <input type="number" class="form-control" id="chlor-flow-physical" name="chlor-flow-physical">
          <label for="chlor-flow-system">System Read (ml):</label>
          <input type="number" class="form-control" id="chlor-flow-system" name="chlor-flow-system">
          <div class="calibration-container" id="chlor-calibration">
            <label for="chlor-pulse-old">Pulse per ml Old:</label>
            <input type="number" step="0.01" class="form-control" id="chlor-pulse-old" name="chlor-pulse-old">
            <label for="chlor-pulse-new">Pulse per ml New:</label>
            <input type="number" step="0.01" class="form-control" id="chlor-pulse-new" name="chlor-pulse-new">
            <label for="chlor-new-test-physical">New Test Physical (ml):</label>
            <input type="number" class="form-control" id="chlor-new-test-physical" name="chlor-new-test-physical">
            <label for="chlor-new-system-result">New System Result (ml):</label>
            <input type="number" class="form-control" id="chlor-new-system-result" name="chlor-new-system-result">
          </div>
        </div>
        <!-- Teat Concentrate Flow Meter -->
        <div class="flow-meter-item checklist-item">
          <h3>Teat Concentrate Flow Meter</h3>
          <label for="teat-flow-physical">Physical Test (ml):</label>
          <input type="number" class="form-control" id="teat-flow-physical" name="teat-flow-physical">
          <label for="teat-flow-system">System Read (ml):</label>
          <input type="number" class="form-control" id="teat-flow-system" name="teat-flow-system">
          <div class="calibration-container" id="teat-calibration">
            <label for="teat-pulse-old">Pulse per ml Old:</label>
            <input type="number" step="0.01" class="form-control" id="teat-pulse-old" name="teat-pulse-old">
            <label for="teat-pulse-new">Pulse per ml New:</label>
            <input type="number" step="0.01" class="form-control" id="teat-pulse-new" name="teat-pulse-new">
            <label for="teat-new-test-physical">New Test Physical (ml):</label>
            <input type="number" class="form-control" id="teat-new-test-physical" name="teat-new-test-physical">
            <label for="teat-new-system-result">New System Result (ml):</label>
            <input type="number" class="form-control" id="teat-new-system-result" name="teat-new-system-result">
          </div>
        </div>
        <!-- Water Flow Meter -->
        <div class="flow-meter-item checklist-item">
          <h3>Water Flow Meter</h3>
          <label for="water-flow-physical">Physical Test (ml):</label>
          <input type="number" class="form-control" id="water-flow-physical" name="water-flow-physical">
          <label for="water-flow-system">System Read (ml):</label>
          <input type="number" class="form-control" id="water-flow-system" name="water-flow-system">
          <div class="calibration-container" id="water-calibration">
            <label for="water-pulse-old">Pulse per ml Old:</label>
            <input type="number" step="0.01" class="form-control" id="water-pulse-old" name="water-pulse-old">
            <label for="water-pulse-new">Pulse per ml New:</label>
            <input type="number" step="0.01" class="form-control" id="water-pulse-new" name="water-pulse-new">
            <label for="water-new-test-physical">New Test Physical (ml):</label>
            <input type="number" class="form-control" id="water-new-test-physical" name="water-new-test-physical">
            <label for="water-new-system-result">New System Result (ml):</label>
            <input type="number" class="form-control" id="water-new-system-result" name="water-new-system-result">
          </div>
        </div>
      </div>
      
      <!-- Buttons at the bottom of the form -->
      <div style="text-align: center;">
        <button type="button" onclick="generatePDF()">Generate PDF</button>
        <button type="button" onclick="viewRecords()">View All Records</button>
        <button type="button" onclick="pilotChecks()">Pilot Checks</button>
      </div>
    </form>
    <div class="version">Version 6.1 (Agora)</div>
  </div>
  
  <!-- RECORDS VIEW -->
  <div id="record-container" class="record-container" style="display: none;">
    <h2>All Agora Records</h2>
    <div class="search-container">
      <input type="text" id="search-dairy-number" class="form-control" placeholder="Search by Dairy Number" oninput="filterRecords()">
    </div>
    <div id="record-list" class="record-list"></div>
    <button class="back-button" onclick="goBack()">Back to Checklist</button>
  </div>
  
  <!-- PILOT CHECKS PAGE -->
  <div id="pilot-checks-page" class="record-container" style="display: none;">
    <h2>Upcoming Agora Shed Checks</h2>
    <div class="pilot-checks-container">
      <!-- Brandmar Farm -->
      <div class="farm-checks">
        <h3>Brandmar Farm</h3>
        <h4>Upcoming Checks</h4>
        <ul>
          <li>Annual Check – Due: 19th June 2025</li>
        </ul>
        <h4>Completed Checks</h4>
        <ul>
          <li>Install Date: 19th June 2024</li>
          <li>2 Week Check: 3rd July 2024</li>
          <li>3 Month Check: 19th Sep 2024</li>
          <li>6 Month Check: 19th Dec 2024</li>
        </ul>
      </div>
      <!-- J Block -->
      <div class="farm-checks">
        <h3>J Block</h3>
        <h4>Upcoming Checks</h4>
        <ul>
          <li>6 Month Check – Due: 3rd June 2025</li>
          <li>Annual Check – Due: 3rd Dec 2025</li>
        </ul>
        <h4>Completed Checks</h4>
        <ul>
          <li>Install Date: 3rd Dec 2024</li>
          <li>2 Week Check: 17th Dec 2024</li>
          <li>3 Month Check: 3rd Mar 2025</li>
        </ul>
      </div>
      <!-- Pukerimu -->
      <div class="farm-checks">
        <h3>Pukerimu</h3>
        <h4>Upcoming Checks</h4>
        <ul>
          <li>Annual Check – Due: 23rd Aug 2025</li>
        </ul>
        <h4>Completed Checks</h4>
        <ul>
          <li>Install Date: 23rd Aug 2024</li>
          <li>2 Week Check: 6th Sep 2024</li>
          <li>3 Month Check: 22nd Nov 2024</li>
          <li>6 Month Check: 24th Feb 2025</li>
        </ul>
      </div>
      <!-- Ferry View -->
      <div class="farm-checks">
        <h3>Ferry View</h3>
        <h4>Upcoming Checks</h4>
        <ul>
          <li>3 Month Check – Due: 19th May 2025</li>
          <li>6 Month Check – Due: 19th Aug 2025</li>
          <li>Annual Check – Due: 19th Feb 2025</li>
        </ul>
        <h4>Completed Checks</h4>
        <ul>
          <li>Install Date: 19th Feb 2025</li>
          <li>2 Week Check: 11th Mar 2025</li>
        </ul>
      </div>
    </div>
    <div style="text-align: center;">
      <button class="back-button" onclick="backToForm()">Back to Checklist</button>
    </div>
  </div>
  
  <!-- SCRIPTS -->
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.0.3/dexie.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
  <script>
    /* FIREBASE & DEXIE INIT */
    const { jsPDF } = window.jspdf;
    const firebaseConfig = {
      apiKey: "AIzaSyDr9nA44Kkej*****GUzbMDECI8cTFI",
      authDomain: "dairy-farm-record-system.firebaseapp.com",
      projectId: "dairy-farm-record-system",
      storageBucket: "dairy-farm-record-system.appspot.com",
      messagingSenderId: "422124188212",
      appId: "1:422124188212:web:1bd31bee8d6e91e301d061"
    };
    firebase.initializeApp(firebaseConfig);
    const storage = firebase.storage();
    const firestore = firebase.firestore();
    const db = new Dexie("OfflineData");
    db.version(5).stores({
      forms: "dairyNumber",
      dairyCompanies: "++id, name",
      teatSprayRatios: "++id, ratio",
      pdfQueue: "++id,dairyNumber,fileName,uploaded,target"
    });
    
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(reg => console.log('Service Worker registered:', reg.scope))
        .catch(err => console.error('SW registration failed:', err));
    }
    
    /* Utility Functions */
    function toTitleCase(str) {
      return str.replace(/\w\S*/g, function(txt) {
        return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
      });
    }
    function autoCapitalizeInput(id) {
      const el = document.getElementById(id);
      if (!el) return;
      el.addEventListener('blur', () => { el.value = toTitleCase(el.value); });
    }
    
    async function setupDairyCompanyDatalist() {
      const defaultCompanies = [
        "Fonterra", "Dairy Goat Co-op", "Green Valley Dairies", "Maui Milk",
        "Oceania", "OFI", "Synlait Milk LTD", "Tatua", "Danone", "Fresha Valley LTD",
        "Mataura Valley Milk", "Open Country Dairy LTD", "Waiu", "Westland Milk Products"
      ];
      const userCompanies = await db.dairyCompanies.toArray();
      const allCompanies = [...defaultCompanies];
      userCompanies.forEach(u => { if (!allCompanies.includes(u.name)) { allCompanies.push(u.name); } });
      const datalist = document.getElementById('dairy-company-list');
      datalist.innerHTML = "";
      allCompanies.forEach(c => { 
        const opt = document.createElement('option');
        opt.value = c;
        datalist.appendChild(opt);
      });
      const dairyCompanyInput = document.getElementById('dairy-company');
      dairyCompanyInput.addEventListener('blur', async () => {
        dairyCompanyInput.value = toTitleCase(dairyCompanyInput.value.trim());
        const typedValue = dairyCompanyInput.value;
        if (typedValue && !allCompanies.includes(typedValue)) {
          await db.dairyCompanies.add({ name: typedValue });
          allCompanies.push(typedValue);
          const newOpt = document.createElement('option');
          newOpt.value = typedValue;
          datalist.appendChild(newOpt);
        }
      });
    }
    
    async function fetchFarmDetails() {
      const dairyNumber = document.getElementById('dairy-number').value.trim();
      if (!dairyNumber) return;
      const storageRef = storage.ref(`Agora Farm Details/${dairyNumber}.json`);
      try {
        const url = await storageRef.getDownloadURL();
        const response = await fetch(url);
        if (!response.ok) throw new Error('Failed to fetch farm details');
        const data = await response.json();
        if (data) {
          document.getElementById('dairy-company').value = toTitleCase(data.dairyCompany || '');
          document.getElementById('address').value = toTitleCase(data.address || '');
          document.getElementById('customer-name').value = toTitleCase(data.customerName || '');
          document.getElementById('region').value = data.region || '';
          document.getElementById('farm-name').value = toTitleCase(data.farmName || '');
          document.getElementById('island').value = data.island || '';
        }
      } catch (error) {
        console.log('No farm details found or error:', error);
      }
    }
    
    async function checkOrCreateFormRecord() {
      const dairyNumber = document.getElementById('dairy-number').value.trim();
      if (!dairyNumber) return;
      let record = await db.forms.get(dairyNumber);
      if (!record) {
        record = { dairyNumber, formData: {}, creationTime: Date.now() };
        await db.forms.put(record);
      }
    }
    async function handleDairyNumberBlur() {
      const dairyNumber = document.getElementById('dairy-number').value.trim();
      if (!dairyNumber) return;
      fetchFarmDetails();
      await checkOrCreateFormRecord();
    }
    
    /* New Checklist Items for Schedule 3 */
    function createSchedule3ChecklistItems() {
      const schedule3Items = [
        "Cluster to milk line",
        "Cluster short Pulse tubes",
        "Cluster pulse tube to pulsator",
        "Cluster bowl seal",
        "Cluster small ring seal",
        "Liners",
        "Milk filter seal",
        "Front Vat tap seal",
        "Back vat tap seal",
        "Vat door seal"
      ];
      const container = document.getElementById('checklist-items');
      container.innerHTML = "";
      schedule3Items.forEach(item => {
        const itemDiv = document.createElement('div');
        itemDiv.classList.add('checklist-item');

        const label = document.createElement('label');
        label.textContent = item;
        itemDiv.appendChild(label);

        const statusSelect = document.createElement('select');
        statusSelect.classList.add('form-select');
        statusSelect.name = `status-${item}`;
        statusSelect.innerHTML = `
          <option value="ok">OK</option>
          <option value="attention-required">Attention Required</option>
          <option value="na">N/A</option>
          <option value="not-checked">Not Checked</option>
        `;
        itemDiv.appendChild(statusSelect);

        const commentsInput = document.createElement('input');
        commentsInput.type = 'text';
        commentsInput.classList.add('form-control');
        commentsInput.name = `comments-${item}`;
        commentsInput.placeholder = 'Comments';
        commentsInput.setAttribute("spellcheck", "true");
        commentsInput.setAttribute("autocorrect", "on");
        itemDiv.appendChild(commentsInput);

        // Two file inputs w/ previews
        for (let i = 0; i < 2; i++) {
          const fileInput = document.createElement('input');
          fileInput.type = 'file';
          fileInput.classList.add('form-control','image-upload');
          itemDiv.appendChild(fileInput);

          const preview = document.createElement('img');
          preview.classList.add('image-preview');
          itemDiv.appendChild(preview);
        }

        // Additional rubberware fields
        const extraDiv = document.createElement('div');
        extraDiv.classList.add('schedule3-extra');
        // Install Date
        const installLabel = document.createElement('label');
        installLabel.textContent = 'Install Date:';
        extraDiv.appendChild(installLabel);
        const installInput = document.createElement('input');
        installInput.type = 'date';
        installInput.classList.add('form-control');
        installInput.name = `install-${item}`;
        extraDiv.appendChild(installInput);

        // Replacement Date
        const replacementLabel = document.createElement('label');
        replacementLabel.textContent = 'Replacement Due Date:';
        extraDiv.appendChild(replacementLabel);
        const replacementInput = document.createElement('input');
        replacementInput.type = 'date';
        replacementInput.classList.add('form-control');
        replacementInput.name = `replacement-${item}`;
        extraDiv.appendChild(replacementInput);

        // Dimensions, Length, Qty
        const rubberwareDiv = document.createElement('div');
        rubberwareDiv.style.display = "flex";
        rubberwareDiv.style.gap = "5px";

        const dimInput = document.createElement('input');
        dimInput.type = 'text';
        dimInput.classList.add('form-control');
        dimInput.name = `rubberware-dimensions-${item}`;
        dimInput.placeholder = 'Dimensions';
        dimInput.setAttribute("autocorrect", "on");
        rubberwareDiv.appendChild(dimInput);

        const lengthInput = document.createElement('input');
        lengthInput.type = 'text';
        lengthInput.classList.add('form-control');
        lengthInput.name = `rubberware-length-${item}`;
        lengthInput.placeholder = 'Length';
        lengthInput.setAttribute("autocorrect", "on");
        rubberwareDiv.appendChild(lengthInput);

        const qtyInput = document.createElement('input');
        qtyInput.type = 'number';
        qtyInput.classList.add('form-control');
        qtyInput.name = `rubberware-quantity-${item}`;
        qtyInput.placeholder = 'Quantity';
        rubberwareDiv.appendChild(qtyInput);

        extraDiv.appendChild(rubberwareDiv);
        itemDiv.appendChild(extraDiv);

        // Show file inputs only if "attention-required"
        statusSelect.addEventListener('change', () => {
          const fileInputs = itemDiv.querySelectorAll('input[type="file"]');
          fileInputs.forEach(inp => {
            inp.style.display = (statusSelect.value === "attention-required") ? "block" : "none";
          });
        });

        container.appendChild(itemDiv);
      });
    }
    
    /* New CLEAR & SAVE functions for Schedule 3 */
    function clearEntireForm() {
      document.getElementById("schedule3-form").reset();
      const imageUploads = document.querySelectorAll(".image-upload");
      imageUploads.forEach(inp => { inp.style.display = "none"; });
      const previews = document.querySelectorAll(".image-preview");
      previews.forEach(img => {
        img.src = "";
        img.style.display = "none";
      });
    }
    
    async function saveFormData() {
      const dairyNumber = document.getElementById("dairy-number").value.trim();
      if (!dairyNumber) return;
      let record = await db.forms.get(dairyNumber);
      if (!record) {
        record = { dairyNumber, formData: {}, creationTime: Date.now() };
      }
    
      const form = document.getElementById("schedule3-form");
      const formDataObj = new FormData(form);
      const data = Object.fromEntries(Array.from(formDataObj.entries()).filter(([k, v]) => v.trim() !== ""));
      data["dairy-number"] = dairyNumber;  // Ensure we keep dairy number
    
      // Gather the checklist items
      const checklistContainers = document.getElementById("checklist-items").children;
      const checklistItemsData = {};
      for (let container of checklistContainers) {
        const label = container.querySelector("label");
        if (!label) continue;
        const key = label.textContent.trim();
    
        const statusSelect = container.querySelector("select");
        const status = statusSelect ? statusSelect.value : "";
        const commentsInput = container.querySelector('input[type="text"]');
        let comments = commentsInput ? commentsInput.value : "";
    
        // Extra fields
        const installInput = container.querySelector(`input[name="install-${key}"]`);
        const replacementInput = container.querySelector(`input[name="replacement-${key}"]`);
        const dimInput = container.querySelector(`input[name="rubberware-dimensions-${key}"]`);
        const lengthInput = container.querySelector(`input[name="rubberware-length-${key}"]`);
        const qtyInput = container.querySelector(`input[name="rubberware-quantity-${key}"]`);
        const extra = {
          installDate: installInput ? installInput.value : "",
          replacementDueDate: replacementInput ? replacementInput.value : "",
          rubberwareDimensions: dimInput ? dimInput.value : "",
          rubberwareLength: lengthInput ? lengthInput.value : "",
          rubberwareQuantity: qtyInput ? qtyInput.value : ""
        };
        let imagesBase64 = [];
        const fileInputs = container.querySelectorAll('input[type="file"]');
        for (let fi of fileInputs) {
          if (fi.files && fi.files[0]) {
            const base64 = await convertFileToBase64(fi.files[0]);
            imagesBase64.push(base64);
          }
        }
        if (status === "attention-required" && imagesBase64.length > 0) {
          const photoNote = (imagesBase64.length > 1) ? " (see attached photos)" : " (see attached photo)";
          comments += photoNote;
        }
    
        checklistItemsData[key] = { status, comments, extra, imagesBase64 };
      }
      data.checklistItems = checklistItemsData;
    
      record.formData = data;
      await db.forms.put(record);
    }
    
    function convertFileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }
    
    // Also store farm details in Firebase as `dairyNumber + "schedule3".json`
    async function saveFarmDetailsToFirebase(formData) {
      const dairyNumber = formData.get("dairy-number") || "";
      if (!dairyNumber) return;
      const key = dairyNumber + "schedule3";
      const farmDetails = {
        dairyCompany: formData.get("dairy-company") || "",
        address: formData.get("address") || "",
        customerName: formData.get("customer-name") || "",
        region: formData.get("region") || "",
        farmName: formData.get("farm-name") || "",
        island: formData.get("island") || "",
        visitDate: formData.get("visit-date") || ""
      };
      const jsonBlob = new Blob([JSON.stringify(farmDetails)], { type: "application/json" });
      try {
        const storageRef = storage.ref(`Agora Farm Details/${key}.json`);
        await storageRef.put(jsonBlob);
        console.log("Farm details JSON saved to Agora Farm Details folder (schedule3).");
      } catch (err) {
        console.error("Error saving farm details JSON:", err);
      }
    }
    
    // Keep using pdfQueue but now with target "schedule3"
    window.addEventListener("online", uploadPendingPDFs);
    
    async function uploadPendingPDFs() {
      if (!navigator.onLine) return;
      const queuedPDFs = await db.pdfQueue.toArray();
      for (let pdfRecord of queuedPDFs) {
        if (pdfRecord.target === "schedule3") {
          try {
            await uploadSinglePDFSchedule3(pdfRecord.dairyNumber, pdfRecord.fileName, pdfRecord.pdfBlob);
            await db.pdfQueue.delete(pdfRecord.id);
            console.log(`Retried PDF for ${pdfRecord.dairyNumber} uploaded successfully (schedule3).`);
          } catch (err) {
            console.error("Retry PDF upload to schedule3 failed:", err);
          }
        }
      }
    }
    
    function uploadSinglePDFSchedule3(dairyNumber, fileName, pdfBlob) {
      return new Promise((resolve, reject) => {
        const uploadRef = storage.ref(`Agora schedule 3 Customers/${dairyNumber}/${fileName}`);
        const task = uploadRef.put(pdfBlob);
        task.on("state_changed", null, (err) => reject(err), () => resolve());
      });
    }
    
    async function generatePDF() {
      const dairyNumber = document.getElementById("dairy-number").value.trim();
      if (!dairyNumber) { alert("Please enter a Dairy Number."); return; }
      const form = document.getElementById("schedule3-form");
      const fd = new FormData(form);
      await saveFarmDetailsToFirebase(fd);
      
      const checklistContainers = [
        ...document.getElementById("health-safety-top").children,
        ...document.getElementById("checklist-items").children,
        ...document.getElementById("silo-checklist").children
      ];
      const checklistData = [];
      let imagePromises = [];
      let photoStore = [];
      checklistContainers.forEach(item => {
        const labelEl = item.querySelector("label");
        if (!labelEl) return;
        const itemName = labelEl.textContent;
        const status = item.querySelector("select")?.value || "";
        let comments = item.querySelector("input[type='text']")?.value || "";
        const fileInputs = item.querySelectorAll("input[type='file']");
        let images = [];
        fileInputs.forEach(inp => {
          if (inp.files && inp.files[0]) { images.push(inp.files[0]); }
        });
        if (status === "attention-required" && images.length > 0) {
          const photoNote = images.length > 1 ? " (see attached photos)" : " (see attached photo)";
          comments += photoNote;
          const p = { itemName, images: [] };
          images.forEach((file, idx) => {
            imagePromises.push(convertFileToBase64(file).then(result => { p.images[idx] = result; }));
          });
          photoStore.push(p);
        }
        checklistData.push([itemName, status, comments]);
      });
      
      let tempSensorData = [];
      const tsContainer = document.getElementById("temperature-sensors-container");
      const tsItem = tsContainer.querySelector(".checklist-item");
      if (tsItem) {
        const tsType = tsItem.querySelector("input[name='tempSensor-type']").value;
        const tsTested = tsItem.querySelector("input[name='tempSensor-tested']").value;
        const tsSystem = tsItem.querySelector("input[name='tempSensor-system']").value;
        const tsComments = tsItem.querySelector("input[name='tempSensor-comments']").value;
        tempSensorData.push([tsType, tsTested, tsSystem, tsComments]);
      }
      
      const pageWidth = 595;
      const leftColLabelWidth = pageWidth * 0.15;
      const leftColValueWidth = pageWidth * 0.20;
      const rightColLabelWidth = pageWidth * 0.20;
      const rightColValueWidth = pageWidth * 0.30;
      const farmDetailsRows = [
        [
          { content: "Dairy Company:", styles: { fontStyle: "bold" } },
          { content: (fd.get("dairy-company") || ""), styles: { fontStyle: "normal" } },
          { content: "Visit Type:", styles: { fontStyle: "bold" } },
          { content: (fd.get("visit-type") || ""), styles: { fontStyle: "normal" } }
        ],
        [
          { content: "Dairy Number:", styles: { fontStyle: "bold" } },
          { content: (fd.get("dairy-number") || ""), styles: { fontStyle: "normal" } },
          { content: "Inspection Start Time:", styles: { fontStyle: "bold" } },
          { content: (fd.get("inspection-start-time") || ""), styles: { fontStyle: "normal" } }
        ],
        [
          { content: "Address:", styles: { fontStyle: "bold" } },
          { content: (fd.get("address") || ""), styles: { fontStyle: "normal" } },
          { content: "Inspection End Time:", styles: { fontStyle: "bold" } },
          { content: (fd.get("inspection-end-time") || ""), styles: { fontStyle: "normal" } }
        ],
        [
          { content: "Customer Name:", styles: { fontStyle: "bold" } },
          { content: (fd.get("customer-name") || ""), styles: { fontStyle: "normal" } },
          { content: "Inspection Completed By:", styles: { fontStyle: "bold" } },
          { content: (fd.get("inspection-completed-by") || ""), styles: { fontStyle: "normal" } }
        ],
        [
          { content: "Visit Date:", styles: { fontStyle: "bold" } },
          { content: (fd.get("visit-date") || ""), styles: { fontStyle: "normal" } },
          { content: "Call Type:", styles: { fontStyle: "bold" } },
          { content: (fd.get("call-type") || ""), styles: { fontStyle: "normal" } }
        ]
      ];
      
      const hotWaterTemp = fd.get("hot-water-temp") || "";
      const hotWaterTime = fd.get("hot-water-time") || "--:-- --";
      const milkTemp = fd.get("milk-temp") || "";
      const milkTime = fd.get("milk-time") || "--:-- --";
      const tempMeasurementData = [
        ["Hot Water Temp (°C):", hotWaterTemp],
        ["Time Taken:", hotWaterTime],
        ["Milk Temp (°C):", milkTemp],
        ["Time Taken:", milkTime]
      ];
      
      let flowMeters = [];
      const flowMeterMapping = {
         "Acid Flow Meter": { main: "acid-flow", extra: "acid" },
         "Chlor Alkali Flow Meter": { main: "chlor-flow", extra: "chlor" },
         "Teat Concentrate Flow Meter": { main: "teat-flow", extra: "teat" },
         "Water Flow Meter": { main: "water-flow", extra: "water" }
      };
      for (let meter in flowMeterMapping) {
         const prefixes = flowMeterMapping[meter];
         const physical = fd.get(prefixes.main + "-physical") || "";
         const system = fd.get(prefixes.main + "-system") || "";
         flowMeters.push([meter, physical + " ml", system + " ml"]);
         const pulseOld = fd.get(prefixes.extra + "-pulse-old") || "";
         const pulseNew = fd.get(prefixes.extra + "-pulse-new") || "";
         const newTestPhysical = fd.get(prefixes.extra + "-new-test-physical") || "";
         const newSystemResult = fd.get(prefixes.extra + "-new-system-result") || "";
         if(pulseOld || pulseNew || newTestPhysical || newSystemResult){
           let extraLeft = "";
           let extraRight = "";
           if(pulseOld) extraLeft += "Pulse Old: " + pulseOld;
           if(pulseNew) extraLeft += (extraLeft ? ", " : "") + "Pulse New: " + pulseNew;
           if(newTestPhysical) extraRight += "Test Physical: " + newTestPhysical;
           if(newSystemResult) extraRight += (extraRight ? ", " : "") + "System Result: " + newSystemResult;
           flowMeters.push(["Calibration:", extraLeft, extraRight]);
         }
      }
      
      Promise.all(imagePromises).then(() => {
        finalizePDF();
      }).catch(() => {
        finalizePDF();
      });
      
      function finalizePDF() {
        const pdf = new jsPDF("p", "pt", "a4");
        let currentY = 40;
        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();
        storage.ref("Agora Logo/2F6-1YdaEP.jpeg").getDownloadURL().then(url => {
          fetch(url)
            .then(res => res.blob())
            .then(blob => convertFileToBase64(blob))
            .then(logoBase64 => {
              const img = new Image();
              img.onload = function() {
                const fixedLogoWidth = 150;
                const fixedLogoHeight = (img.height * fixedLogoWidth) / img.width;
                const x = (pageWidth - fixedLogoWidth) / 2;
                pdf.addImage(logoBase64, "JPEG", x, 40, fixedLogoWidth, fixedLogoHeight);
                currentY = 40 + fixedLogoHeight + 20;
                addFarmDetailsAndTables(pdf);
              };
              img.src = logoBase64;
            })
            .catch(err => {
              console.error("Logo error:", err);
              addFarmDetailsAndTables(pdf);
            });
        }).catch(err => {
          console.error("Logo error:", err);
          addFarmDetailsAndTables(pdf);
        });
        
        function addFarmDetailsAndTables(pdf) {
          pdf.autoTable({
            startY: currentY,
            head: [["Farm Details", "", "", ""]],
            body: farmDetailsRows,
            theme: 'grid',
            styles: { fontSize: 10, cellPadding: 5 },
            headStyles: { fillColor: "#002B5C", textColor: "#fff" },
            columnStyles: {
              0: { cellWidth: leftColLabelWidth },
              1: { cellWidth: leftColValueWidth },
              2: { cellWidth: rightColLabelWidth, halign: 'right' },
              3: { cellWidth: rightColValueWidth, halign: 'right' }
            },
            margin: { left: 40, right: 40 }
          });
          currentY = pdf.lastAutoTable.finalY + 20;
          
          pdf.autoTable({
            startY: currentY,
            head: [["Temperature Measurement", ""]],
            body: tempMeasurementData,
            styles: { fontSize: 10, cellPadding: 5 },
            headStyles: { fillColor: "#002B5C", textColor: "#fff" },
            margin: { left: 40, right: 40 }
          });
          currentY = pdf.lastAutoTable.finalY + 20;
          
          pdf.setFont("helvetica", "bold");
          pdf.text("Checklist Items:", 40, currentY);
          currentY += 10;
          pdf.autoTable({
            startY: currentY,
            head: [["Item", "Status", "Comments"]],
            body: checklistData,
            styles: { fontSize: 10, cellPadding: 5 },
            headStyles: { fillColor: "#002B5C", textColor: "#fff" },
            margin: { left: 40, right: 40 }
          });
          currentY = pdf.lastAutoTable.finalY + 20;
          
          if (tempSensorData.length > 0) {
            pdf.setFont("helvetica", "bold");
            pdf.text("Temperature Sensors:", 40, currentY);
            currentY += 10;
            pdf.autoTable({
              startY: currentY,
              head: [["Sensor Type", "Tested Temp (°C)", "System Temp (°C)", "Comments"]],
              body: tempSensorData,
              styles: { fontSize: 10, cellPadding: 5 },
              headStyles: { fillColor: "#002B5C", textColor: "#fff" },
              margin: { left: 40, right: 40 }
            });
            currentY = pdf.lastAutoTable.finalY + 20;
          }
          
          if (flowMeters.length > 0) {
            pdf.setFont("helvetica", "bold");
            pdf.text("Flow Meters:", 40, currentY);
            currentY += 10;
            pdf.autoTable({
              startY: currentY,
              head: [["Meter", "Physical Test", "System Read"]],
              body: flowMeters,
              styles: { fontSize: 10, cellPadding: 5 },
              headStyles: { fillColor: "#002B5C", textColor: "#fff" },
              margin: { left: 40, right: 40 }
            });
            currentY = pdf.lastAutoTable.finalY + 20;
          }
          
          if (photoStore.length > 0) {
            pdf.setFont("helvetica", "bold");
            if (currentY + 20 > pageHeight) {
              pdf.addPage();
              currentY = 40;
            }
            pdf.text("Attached Photos:", 40, currentY);
            currentY += 20;
            photoStore.forEach(photoItem => {
              if (currentY + 15 > pageHeight) {
                pdf.addPage();
                currentY = 40;
              }
              pdf.setFont("helvetica", "bold");
              pdf.text(photoItem.itemName, 40, currentY);
              currentY += 15;
              let maxImgHeight = 0;
              photoItem.images.forEach((img, idx) => {
                try {
                  const imgProps = pdf.getImageProperties(img);
                  const imgWidth = 250;
                  const imgHeight = (imgProps.height * imgWidth) / imgProps.width;
                  if (currentY + imgHeight > pageHeight) {
                    pdf.addPage();
                    currentY = 40;
                  }
                  pdf.addImage(img, "JPEG", 40 + idx * (imgWidth + 10), currentY, imgWidth, imgHeight);
                  if (imgHeight > maxImgHeight) maxImgHeight = imgHeight;
                } catch(e) {
                  console.error("Error adding image:", e);
                }
              });
              currentY += maxImgHeight + 20;
            });
          }
          
          (async function(){
            const pdfBlob = pdf.output("blob");
            const visitDate = fd.get("visit-date");
            if (!visitDate) {
              alert("Visit Date is required.");
              return;
            }
            const dateParts = visitDate.split("-");
            const formattedVisitDate = dateParts[2] + "-" + dateParts[1] + "-" + dateParts[0].substr(2);
            const fileName = `${fd.get("dairy-number")}-form-${formattedVisitDate}.pdf`;
            try {
              await uploadSinglePDFSchedule3(dairyNumber, fileName, pdfBlob);
              console.log("PDF uploaded to Agora schedule 3 Customers folder successfully");
            } catch(e) {
              console.error("PDF upload to Agora schedule 3 Customers folder failed:", e);
              db.pdfQueue.add({ dairyNumber, fileName, pdfBlob, uploaded: false, target: "schedule3" });
            }
            db.forms.delete(fd.get("dairy-number"));
            pdf.save(fileName);
            uploadPendingPDFs();
            clearEntireForm();
            location.reload();
          })();
        }
      }
    }
    
    function viewRecords() {
      document.getElementById("form-container").style.display = "none";
      document.getElementById("pilot-checks-page").style.display = "none";
      document.getElementById("record-container").style.display = "block";
      loadAllRecords();
    }
    
    async function loadAllRecords() {
      const recordList = document.getElementById("record-list");
      recordList.innerHTML = "";
      const storageRef = storage.ref("Agora schedule 3 Customers");
      try {
        const folderSnapshot = await storageRef.listAll();
        if (folderSnapshot.prefixes.length > 0) {
          folderSnapshot.prefixes.forEach(folderRef => {
            const dairyNumber = folderRef.name;
            const link = document.createElement("a");
            link.textContent = dairyNumber;
            link.href = "#";
            link.style.display = "block";
            link.addEventListener("click", () => loadRecordFiles(dairyNumber));
            recordList.appendChild(link);
          });
        }
        if (folderSnapshot.items.length > 0) {
          folderSnapshot.items.forEach(fileRef => {
            const fileName = fileRef.name;
            const link = document.createElement("a");
            link.textContent = fileName;
            link.href = "#";
            link.style.display = "block";
            link.addEventListener("click", async () => {
              try {
                const url = await fileRef.getDownloadURL();
                window.open(url, "_blank");
              } catch (err) {
                console.error("Error fetching file:", err);
              }
            });
            recordList.appendChild(link);
          });
        }
      } catch (error) {
        console.error("Error fetching records:", error);
      }
    }
    
    async function loadRecordFiles(dairyNumber) {
      const recordList = document.getElementById("record-list");
      recordList.innerHTML = "";
      const folderRef = storage.ref(`Agora schedule 3 Customers/${dairyNumber}`);
      try {
        const fileSnapshot = await folderRef.listAll();
        fileSnapshot.items.forEach(fileRef => {
          const fileName = fileRef.name;
          const dateMatch = fileName.match(/(\d{4}-\d{2}-\d{2})/);
          const displayName = dateMatch ? dateMatch[0] : fileName;
          const fileLink = document.createElement("a");
          fileLink.textContent = displayName;
          fileLink.href = "#";
          fileLink.style.display = "block";
          fileLink.addEventListener("click", async () => {
            try {
              const url = await fileRef.getDownloadURL();
              window.open(url, "_blank");
            } catch (err) {
              console.error("Error fetching file:", err);
            }
          });
          recordList.appendChild(fileLink);
        });
        const backBtn = document.createElement("button");
        backBtn.textContent = "Back to Records";
        backBtn.className = "back-button";
        backBtn.addEventListener("click", loadAllRecords);
        recordList.appendChild(backBtn);
      } catch (err) {
        console.error("Error fetching record files:", err);
      }
    }
    
    function filterRecords() {
      const searchValue = document.getElementById("search-dairy-number").value.toLowerCase();
      const recordList = document.getElementById("record-list");
      const links = recordList.getElementsByTagName("a");
      for (let i = 0; i < links.length; i++) {
        const txt = links[i].textContent || links[i].innerText;
        links[i].style.display = txt.toLowerCase().includes(searchValue) ? "" : "none";
      }
    }
    
    function goBack() {
      document.getElementById("record-container").style.display = "none";
      document.getElementById("form-container").style.display = "block";
    }
    
    function pilotChecks() {
      document.getElementById("form-container").style.display = "none";
      document.getElementById("record-container").style.display = "none";
      document.getElementById("pilot-checks-page").style.display = "block";
    }
    
    function backToForm() {
      document.getElementById("pilot-checks-page").style.display = "none";
      document.getElementById("form-container").style.display = "block";
    }
    
    function setupFlowMeterTolerance(physicalId, systemId, calibrationId) {
      const physicalInput = document.getElementById(physicalId);
      const systemInput = document.getElementById(systemId);
      const calibrationContainer = document.getElementById(calibrationId);
      function updateCalibrationDisplay() {
        const physicalValue = parseFloat(physicalInput.value);
        const systemValue = parseFloat(systemInput.value);
        if (!isNaN(physicalValue) && !isNaN(systemValue)) {
          const tolerance = 0.05 * physicalValue;
          calibrationContainer.style.display = (Math.abs(physicalValue - systemValue) > tolerance) ? "block" : "none";
        } else {
          calibrationContainer.style.display = "none";
        }
      }
      physicalInput.addEventListener("input", updateCalibrationDisplay);
      systemInput.addEventListener("input", updateCalibrationDisplay);
    }
    
    document.addEventListener("DOMContentLoaded", async () => {
      const fieldsToAutoCap = ["dairy-number", "dairy-company", "address", "customer-name", "farm-name", "inspection-completed-by"];
      fieldsToAutoCap.forEach(autoCapitalizeInput);
      await setupDairyCompanyDatalist();
      createHealthSafetyItems("health-safety-top");
      createSchedule3ChecklistItems();
      createSiloChecklist();
      createTemperatureSensorItem();
      const form = document.getElementById("schedule3-form");
      form.addEventListener("input", saveFormData);
      form.addEventListener("change", saveFormData);
      uploadPendingPDFs();
      setupFlowMeterTolerance("acid-flow-physical", "acid-flow-system", "acid-calibration");
      setupFlowMeterTolerance("chlor-flow-physical", "chlor-flow-system", "chlor-calibration");
      setupFlowMeterTolerance("teat-flow-physical", "teat-flow-system", "teat-calibration");
      setupFlowMeterTolerance("water-flow-physical", "water-flow-system", "water-calibration");
    });
  </script>
</body>
</html>
